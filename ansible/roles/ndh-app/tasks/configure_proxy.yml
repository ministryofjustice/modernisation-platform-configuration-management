---
- name: Add nginx yum repo
  yum_repository:
    name: nginx
    description: nginx repo
    baseurl: https://nginx.org/packages/rhel/7/$basearch/
    gpgcheck: no
    enabled: yes
  tags:
    - amibuild

- name: Enable nginx
  ansible.builtin.service:
    name: nginx
    enabled: yes
    state: stopped
  tags:
    - amibuild

- name: Add nginx proxy config
  template:
    src: etc/nginx/nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify:
    - test nginx config
  tags:
    - amibuild

- meta: flush_handlers
  tags:
    - amibuild

- name: Create ssl directory in /etc/nginx
  file:
    path: /etc/nginx/ssl
    state: directory
    owner: nginx
    group: nginx
  tags:
    - amibuild

- name: Generate a private key
  community.crypto.openssl_privatekey:
    path: /etc/nginx/ssl/nginx.key
    type: RSA
    size: 2048
  tags:
    - amibuild

- name: Create a CSR for the ndh_proxy_host
  community.crypto.openssl_csr:
    path: /etc/nginx/ssl/nginx.csr
    privatekey_path: /etc/nginx/ssl/nginx.key
    common_name: "{{ ndh_proxy_host }}"

- name: Generate a self-signed certificate
  community.crypto.x509_certificate:
    path: /etc/nginx/ssl/nginx.crt
    privatekey_path: /etc/nginx/ssl/nginx.key
    csr_path: /etc/nginx/ssl/nginx.csr
    provider: selfsigned
    force: yes
  tags:
    - amibuild

# - name: Read certificate contents
#   slurp:
#     src: /etc/nginx/ssl/nginx.crt
#   register: cert_contents

# - name: Put the certificate into an SSM parameter
#   ansible.builtin.shell: |
#     PATH=$PATH:/usr/local/bin
#     aws ssm put-parameter --name /ndh/{{ ndh_proxy_host }}/nginx.crt --value "{{ (cert_contents.content | b64decode) }}" --type SecureString --overwrite
#   tags:
#     - amibuild

- name: add ndh_proxy_host to /etc/hosts for loopback
  lineinfile:
    path: /etc/hosts
    regexp: '^(127\.0\.0\.1.*)$'
    line: '\1 {{ ndh_proxy_host }}'
    backrefs: yes
  tags:
    - amibuild

- name: Start nginx
  ansible.builtin.service:
    name: nginx
    enabled: yes
    state: started
  tags:
    - amibuild
