- block:

    - name: Create a temporary file on the remote host
      tempfile:
        state: file
        suffix: ".json"
      register: temp_file

    - name: Copy baseline data to the temporary file on the remote host
      copy:
        src: "{{ filename }}"
        dest: "{{ temp_file.path }}"
        mode: '0644'

    - name: Import Baseline
      become_user: oracle
      become: true
      block:

        - name: Create Directory for BFile
          script: create_baseline_directory.sh $(dirname {{ temp_file.path }})
          environment:
             TARGET_DB_NAME: "{{ target_db_name }}"

        - name: Create View of Baseline Data
          script: create_baseline_view.sh {{ temp_file.path | basename }}
          environment:
             TARGET_DB_NAME: "{{ target_db_name }}"
             DBA_OPS_SCHEMA: "{{ dba_ops_schema | default('SYSTEM') }}"

        - name: Import Baseline
          script: import_baseline.sh
          environment:
             TARGET_DB_NAME: "{{ target_db_name }}"
             DBA_OPS_SCHEMA: "{{ dba_ops_schema | default('SYSTEM') }}"
  always:

    - name: Remove temporary file
      file:
        path: "{{ temp_file.path }}"
        state: absent
      when: temp_file.path is defined 

    - name: Remove Baseline View
      script: drop_baseline_view.sh
      environment:
          TARGET_DB_NAME: "{{ target_db_name }}"
          DBA_OPS_SCHEMA: "{{ dba_ops_schema | default('SYSTEM') }}"

    - name: Remove Baseline Directory
      script: drop_baseline_directory.sh
      environment:
          TARGET_DB_NAME: "{{ target_db_name }}"

  become_user: oracle 
  become: true