---
- name: Configure Oracle GoldenGate credential store
  become: true
  become_user: "{{ oracle_goldengate_owner }}"
  environment: "{{ gg_env }}"
  when: gg_home_exists
  block:
    - name: Execute credential store configuration commands
      ansible.builtin.shell: |
        # Retrieve ggadmin passwords from AWS Secrets Manager
        ggadmin_source_pwd=$(aws secretsmanager get-secret-value \
          --secret-id "/oracle/database/{{ oracle_goldengate_db.source.tns_alias }}/passwords" \
          --query 'SecretString' \
          --output text 2>/dev/null | jq -r '.ggadmin' 2>/dev/null)
        ggadmin_audit_pwd=$(aws secretsmanager get-secret-value \
          --secret-id "/oracle/database/{{ oracle_goldengate_db.audit.tns_alias }}/passwords" \
          --query 'SecretString' \
          --output text 2>/dev/null | jq -r '.ggadmin' 2>/dev/null)
        ggadmin_mis_pwd=$(aws secretsmanager get-secret-value \
          --secret-id "/oracle/database/{{ oracle_goldengate_db.mis.tns_alias }}/passwords" \
          --query 'SecretString' \
          --output text 2>/dev/null | jq -r '.ggadmin' 2>/dev/null)

        export ORACLE_SID={{ oracle_goldengate_local_db_sid }}
        export ORAENV_ASK=NO
        . oraenv > /dev/null 2>&1

        cd {{ oracle_goldengate_home }}
        ./ggsci << EOF
        ADD CREDENTIALSTORE
        ALTER CREDENTIALSTORE DELETE USER {{ oracle_goldengate_dbuser }}@{{ oracle_goldengate_db.source.tns_alias }} ALIAS {{ oracle_goldengate_db.source.credential_alias }}
        ALTER CREDENTIALSTORE DELETE USER {{ oracle_goldengate_dbuser }}@{{ oracle_goldengate_db.audit.tns_alias }} ALIAS {{ oracle_goldengate_db.audit.credential_alias }}
        ALTER CREDENTIALSTORE DELETE USER {{ oracle_goldengate_dbuser }}@{{ oracle_goldengate_db.mis.tns_alias }} ALIAS {{ oracle_goldengate_db.mis.credential_alias }}
        ALTER CREDENTIALSTORE ADD USER {{ oracle_goldengate_dbuser }}@{{ oracle_goldengate_db.source.tns_alias }} PASSWORD ${ggadmin_source_pwd} ALIAS {{ oracle_goldengate_db.source.credential_alias }}
        ALTER CREDENTIALSTORE ADD USER {{ oracle_goldengate_dbuser }}@{{ oracle_goldengate_db.audit.tns_alias }} PASSWORD ${ggadmin_audit_pwd} ALIAS {{ oracle_goldengate_db.audit.credential_alias }}
        ALTER CREDENTIALSTORE ADD USER {{ oracle_goldengate_dbuser }}@{{ oracle_goldengate_db.mis.tns_alias }} PASSWORD ${ggadmin_mis_pwd} ALIAS {{ oracle_goldengate_db.mis.credential_alias }}
        INFO CREDENTIALSTORE
        EXIT
        EOF
      become: yes
      become_user: "{{ oracle_goldengate_owner }}"
      register: credstore_output
      changed_when: "'Credential store created' in credstore_output.stdout or 'Credential store altered' in credstore_output.stdout"
      failed_when: credstore_output.rc != 0 and 'already exists' not in credstore_output.stderr

    - name: Display credential store configuration output
      ansible.builtin.debug:
        var: credstore_output.stdout_lines
      when: credstore_output is defined
