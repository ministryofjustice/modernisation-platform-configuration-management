---
# GoldenGate Role Main Task File
# Each task has unique tags for independent testing
# See TAG_BEST_PRACTICES.md for details

- name: Set deployment target host as a fact for use in templates
  ansible.builtin.set_fact:
    target_host: "{{ inventory_hostname }}"
  when: (inventory_hostname is defined) and (inventory_hostname|length > 0)
  
- name: Detect local Oracle database instance
  import_tasks: detect_local_database.yml
  when: oracle_goldengate_local_db_sid is not defined or oracle_goldengate_local_db_sid == ""
  tags: 
    - always
    - detect-database

- name: Install Oracle GoldenGate binaries
  import_tasks: install_software.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-software
    - install-software

- name: Install Oracle GoldenGate patches
  import_tasks: install_patches.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-software
    - goldengate-patches
    - install-patches

- name: Configure Oracle ASM
  import_tasks: configure_asm.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - configure-asm

- name: Configure GoldenGate home subdirectories and mgr
  import_tasks: configure_gg_home.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - configure-home

- name: Configure Oracle database parameters for GoldenGate
  import_tasks: configure_database_parameters.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - goldengate-database-config
    - configure-db-params

- name: Create GoldenGate database administrator and schema users
  import_tasks: create_gg_dbusers.yml
  when: oracle_goldengate_local_db_sid is defined and oracle_goldengate_local_db_sid != ""
  tags:
    - goldengate
    - goldengate-install
    - goldengate-database-config
    - goldengate-dbuser
    - create-dbusers

- name: Configure GoldenGate credential store
  import_tasks: configure_credential_store.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - goldengate-credentials
    - configure-credentials

# Database-specific deployment tasks
- name: Deploy Source GoldenGate database objects (packages, control tables)
  import_tasks: deploy_db_objects_source.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - deploy-source
    - deploy-source-objects

- name: Deploy AuditRef GoldenGate database objects (packages, control tables)
  import_tasks: deploy_db_objects_auditref.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - deploy-auditref
    - deploy-auditref-objects

- name: Deploy AuditData GoldenGate database objects (packages, control tables)
  import_tasks: deploy_db_objects_auditdata.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - deploy-auditdata
    - deploy-auditdata-objects

- name: Deploy MIS GoldenGate database objects (packages, control tables)
  import_tasks: deploy_db_objects_mis.yml
  tags:
    - goldengate
    - goldengate-install
    - goldengate-config
    - deploy-mis
    - deploy-mis-objects

# Audit database processes (AUDITDATA and AUDITREF)
- name: Install GoldenGate extract processes (Audit databases)
  import_tasks: install_audit_extract.yml
  when: oracle_goldengate_deploy_auditdata or oracle_goldengate_deploy_auditref
  tags:
    - goldengate
    - goldengate-config
    - goldengate-processes
    - goldengate-audit
    - goldengate-extract
    - install-audit-extract

- name: Install GoldenGate replicat processes (Audit databases)
  import_tasks: install_audit_replicat.yml
  when: oracle_goldengate_deploy_auditdata or oracle_goldengate_deploy_auditref
  tags:
    - goldengate
    - goldengate-config
    - goldengate-processes
    - goldengate-audit
    - goldengate-replicat
    - install-audit-replicat

# MIS database processes
- name: Install GoldenGate extract processes (MIS database)
  import_tasks: install_mis_extract.yml
  when: oracle_goldengate_deploy_mis
  tags:
    - goldengate
    - goldengate-config
    - goldengate-processes
    - goldengate-mis
    - goldengate-extract
    - install-mis-extract

- name: Install GoldenGate replicat processes (MIS database)
  import_tasks: install_mis_replicat.yml
  when: oracle_goldengate_deploy_mis
  tags:
    - goldengate
    - goldengate-config
    - goldengate-processes
    - goldengate-mis
    - goldengate-replicat
    - install-mis-replicat

# Control scripts (deploy on all hosts)
- name: Deploy GoldenGate control scripts
  import_tasks: deploy_control_scripts.yml
  tags:
    - goldengate
    - goldengate-config
    - goldengate-scripts
    - goldengate-audit
    - goldengate-mis
    - deploy-scripts

# Process management tasks
- name: Start GoldenGate processes
  import_tasks: start_processes.yml
  tags:
    - goldengate
    - goldengate-start
    - goldengate-processes
    - never

- name: Stop GoldenGate processes
  import_tasks: stop_processes.yml
  tags:
    - goldengate
    - goldengate-stop
    - goldengate-processes
    - never

# Helper tasks
- name: Get current SCN from databases
  import_tasks: get_current_scn.yml
  tags:
    - goldengate
    - goldengate-info
    - get-current-scn
    - never
