spool /tmp/{{ oracle_goldengate_group_name }}_setup.log

WHENEVER SQLERROR EXIT SUCCESS
set serverout on

PROMPT Executing grants needed for apply dml handler processing:
grant select on DBA_APPLY_DML_HANDLERS to {{ oracle_goldengate_sql_owner }};
grant select on DBA_REGISTERED_ARCHIVED_LOG to {{ oracle_goldengate_sql_owner }};
grant select on DBA_CAPTURE to {{ oracle_goldengate_sql_owner }};
grant select on dba_db_links to {{ oracle_goldengate_sql_owner }};

-- execute DBMS_STREAMS_AUTH.GRANT_ADMIN_PRIVILEGE('{{ oracle_goldengate_dbuser }}');
grant execute on sys.dbms_lob to {{ oracle_goldengate_dbuser }};
grant execute on sys.dbms_reputil2 to {{ oracle_goldengate_dbuser }};

grant dba to {{ oracle_goldengate_dbuser }};
grant select any table to {{ oracle_goldengate_dbuser }};
grant insert any table to {{ oracle_goldengate_dbuser }};
grant update any table to {{ oracle_goldengate_dbuser }};
grant delete any table to {{ oracle_goldengate_dbuser }};
grant write on directory AUD_ARCHIVELOG_DIR to {{ oracle_goldengate_dbuser }};
grant read on directory AUD_ARCHIVELOG_DIR to {{ oracle_goldengate_dbuser }};
grant execute on sys.dbms_lock to {{ oracle_goldengate_dbuser }};
grant create any procedure to {{ oracle_goldengate_dbuser }};
grant alter any procedure to {{ oracle_goldengate_dbuser }};
grant drop any procedure to {{ oracle_goldengate_dbuser }};
grant select any sequence to {{ oracle_goldengate_dbuser }};
--grant select on sys.gv_$streams_apply_server to {{ oracle_goldengate_dbuser }};
grant analyze any to {{ oracle_goldengate_dbuser }};

-- we need public synonyms for each auditref target table for the auditdata jobs
DECLARE
	l_grant varchar2(1000);
BEGIN
  FOR i IN (SELECT table_name FROM dba_tables where owner = '{{ oracle_goldengate_group.auditref.target_schema }}' ORDER BY 1) LOOP
		l_grant := 'grant select on {{ oracle_goldengate_group.auditref.target_schema }}.'||i.table_name||' to {{ oracle_goldengate_sql_owner }}';
		EXECUTE IMMEDIATE l_grant;
		l_grant := 'create or replace public synonym '||i.table_name||' for {{ oracle_goldengate_group.auditref.target_schema }}.'||i.table_name;
		EXECUTE IMMEDIATE l_grant;
	END LOOP;
END;
/

PROMPT Compiling packages as {{ oracle_goldengate_sql_owner }}:
@AUDITDATA_GEN_PKG.sql
@AUDITDATA_GG_CTL_PKG.sql
@AUDITDATA_CONV_PKG.sql
@AUDITDATA_DML_PKG.sql
@AUDITDATA_JOB_PKG.sql
@AUD_DBA_IMP_PKG.sql

@AUDITDATA_GEN_PBODY.sql
@AUDITDATA_GG_CTL_PBODY.sql
@AUDITDATA_CONV_PBODY.sql
@AUDITDATA_DML_PBODY.sql
@AUDITDATA_JOB_PBODY.sql
@AUD_DBA_IMP_PBODY.sql

create or replace public synonym AUDITDATA_GEN_PKG for {{ oracle_goldengate_sql_owner }}.AUDITDATA_GEN_PKG;
create or replace public synonym AUDITDATA_GG_CTL_PKG for {{ oracle_goldengate_sql_owner }}.AUDITDATA_GG_CTL_PKG;
create or replace public synonym AUDITDATA_CONV_PKG for {{ oracle_goldengate_sql_owner }}.AUDITDATA_CONV_PKG;
create or replace public synonym AUDITDATA_DML_PKG for {{ oracle_goldengate_sql_owner }}.AUDITDATA_DML_PKG;
create or replace public synonym AUDITDATA_JOB_PKG for {{ oracle_goldengate_sql_owner }}.AUDITDATA_JOB_PKG;
create or replace public synonym AUD_DBA_IMP_PKG1 for {{ oracle_goldengate_sql_owner }}.AUD_DBA_IMP_PKG1;
grant execute on {{ oracle_goldengate_sql_owner }}.AUDITDATA_GEN_PKG to {{ oracle_goldengate_dbuser }};
grant execute on {{ oracle_goldengate_sql_owner }}.AUDITDATA_GG_CTL_PKG to {{ oracle_goldengate_dbuser }};
grant execute on {{ oracle_goldengate_sql_owner }}.AUDITDATA_CONV_PKG to {{ oracle_goldengate_dbuser }};
grant execute on {{ oracle_goldengate_sql_owner }}.AUDITDATA_DML_PKG to {{ oracle_goldengate_dbuser }};
grant execute on {{ oracle_goldengate_sql_owner }}.AUDITDATA_JOB_PKG to {{ oracle_goldengate_dbuser }};
grant execute on {{ oracle_goldengate_sql_owner }}.AUD_DBA_IMP_PKG1 to {{ oracle_goldengate_dbuser }};

declare
  v_env_var varchar2(255) := 'SOURCE_DB_PASSWORD';
  v_source_db_pwd varchar2(255);
begin
  dbms_system.get_env(v_env_var, v_source_db_pwd);
  -- Recreate the nomis db link as it was connecting with the strmadmin user and should now use the same password as the goldengate db user
  if v_source_db_pwd is null then
    raise_application_error(-20001, 'Source database password not found in environment variable '||v_env_var);
  end if;
  {{ oracle_goldengate_sql_owner }}.AUD_DBA_IMP_PKG1.add_database_link(
    p_db_link => '{{ oracle_goldengate_group.source.tns_alias }}.REGRESS.RDBMS.DEV.US.ORACLE.COM',
    p_username => UPPER('{{ oracle_goldengate_dbuser }}'),
    p_password => v_source_db_pwd,
    p_host => '{{ oracle_goldengate_group.source.tns_alias }}'
  );
end;
/

-- Move this to after the set up of the Replicat
PROMPT Executing procedures to set up Apply dml handler configuration:
-- will be done as part of the start_replicat call
--EXECUTE {{ oracle_goldengate_sql_owner }}.AUDITDATA_DML_PKG.apply_dml_deconf;
--EXECUTE {{ oracle_goldengate_sql_owner }}.AUDITDATA_DML_PKG.apply_dml_conf;

-- not needed as GG doesn't use these attributes
--begin 
--    DBMS_CAPTURE_ADM.INCLUDE_EXTRA_ATTRIBUTE(capture_name => 'OGG$CAP_{{ oracle_goldengate_group.auditdata.extract_name }}', attribute_name => 'USERNAME', include => true);
--    DBMS_CAPTURE_ADM.INCLUDE_EXTRA_ATTRIBUTE(capture_name => 'OGG$CAP_{{ oracle_goldengate_group.auditdata.extract_name }}', attribute_name => 'SESSION#', include => true);
--end;
--/

PROMPT Create new index for performance
DECLARE
    v_count INTEGER;
BEGIN
  -- check if index exists before trying to create it, as it may already exist if the script has been run before
  SELECT COUNT(*) INTO v_count FROM all_indexes WHERE index_name = 'AUDIT_ERROR_DATETIME_INDX' AND owner = UPPER('{{ oracle_goldengate_sql_owner }}');
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX {{ oracle_goldengate_sql_owner }}.audit_error_datetime_indx ON {{ oracle_goldengate_sql_owner }}.audit_error(error_datetime)';
  END IF;
END;
/

spool off 
