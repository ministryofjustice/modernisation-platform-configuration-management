# Rules to trigger re-evaluation of the Management Pack properties for OEM targets
# whenever somebody visits the Management Pack Access page in the OEM Console. We
# are not allowed to add triggers to the OEM Schema so instead we check for people
# accessing this page in the OHS logs.

module(load="imfile")
module(load="omprog")

# OHS access log -> processed file
input(
    type="imfile"
    File="/u01/app/oracle/product/gc_inst135/user_projects/domains/GCDomain/servers/ohs1/logs/access_log"
    Tag="ohs-access-log"
    Ruleset="pack_page_ruleset"
    freshStartTail="on"
)

ruleset(name="pack_page_ruleset") {

# Match either direct path or wrapper-encoded reference (case-insensitive)
# The relevant page is actually called "LicenseSetup"
  if (
        re_match(tolower($msg), "\"(get|post)[[:space:]]+/em/console/admin/rep/licensesetup(\\?|[[:space:]])")
     or re_match(tolower($msg), "/em/faces/sdk/nonfaceswrapper\\?[^[:space:]]*console%2Fadmin%2Frep%2Flicensesetup")
  ) then {
    action(
        # Simple action just to record that we have spotted somebody accessing the Management Pack page
        type="omfile"
        File="/var/log/rsyslog_management_pack_page_ruleset.log"
    )
    action(
        # Main action to actually call the script that re-evaluates the management pack access
        # (We actually call a "wrapper" script to ensure that the actual script is run as user
        # oracle rather than the rsyslogd owner (normally root).
        # NB: This wrapper script must be runnable by rsyslog - it will normally be blocked
        # by SELinux.  Add an exemption using:
        #  semanage fcontext -a -t bin_t "/home/oracle/admin/em/management_pack_access_wrapper.sh"
        #  restorecon -v /home/oracle/admin/em/management_pack_access_wrapper.sh
        type="omprog"
        binary="/home/oracle/admin/em/management_pack_access_wrapper.sh"
    )
  }
}