---
- name: Check Oracle Enterprise Manager Cloud Control 13c Release 5 already installed
  ansible.builtin.stat:
    path: "{{ oem_mw_home }}/bin/emctl"
  register: oem_software_installed
  tags:
    - always

- import_tasks: get_facts.yml
  tags:
    - always

- debug:
    msg: "B create_oem_repository_db.sh {{ emrepo_db_name.emrepo_db_name }} {{ db_sys_password }} {{ db_system_password }}"
  tags:
    - always

- block:
    - import_tasks: install_oem_prereq.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_software_prereq

    - debug:
        msg: "D create_oem_repository_db.sh {{ emrepo_db_name.emrepo_db_name }} {{ db_sys_password }} {{ db_system_password }}"
      tags:
        - always

    - import_tasks: create_emrepo_database.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_create_emrepo_database

    - import_tasks: download_oem_software.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_software_download

    - import_tasks: install_oem.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_install

    - import_tasks: configure_oem.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_configure

  # block
  when: not oem_software_installed.stat.exists

- import_tasks: oem_ru_upgrade.yml
  tags:
    - amibuild
    - ec2provision
    - oracle_oem_patch_upgrade
