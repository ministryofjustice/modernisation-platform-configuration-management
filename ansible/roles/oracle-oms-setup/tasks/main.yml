---
- name: Check Oracle Enterprise Manager Cloud Control 13c Release 5 already installed
  ansible.builtin.stat:
    path: "{{ oem_mw_home }}/bin/emctl"
  register: oem_software_installed
  tags:
    - always

- import_tasks: get_facts.yml
  tags:
    - always

- block:
    - import_tasks: install_oem_prereq.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_software_prereq

    - import_tasks: create_emrepo_database.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_create_emrepo_database

    - import_tasks: download_oem_software.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_software_download

    - import_tasks: install_oem.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_install

    - import_tasks: configure_oem.yml
      tags:
        - amibuild
        - ec2provision
        - oracle_oem_configure

  # block
  when: not oem_software_installed.stat.exists

- import_tasks: oem_ru_upgrade.yml
  tags:
    - amibuild
    - ec2provision
    - oracle_oem_patch_upgrade

- name: Run Setup for the Central Agent
  import_role:
    name: oracle-oem-agent-setup

- import_tasks: create_group.yml
  tags:
    - amibuild
    - ec2provision
    - dynamic_group

- import_tasks: import_incident_rule_set.yml
  tags:
    - amibuild
    - ec2provision
    - incident_rule_set

- import_tasks: create_slack_wallet.yml
  tags:
    - amibuild
    - ec2provision
    - create_slack_wallet

- import_tasks: create_slack_notification_package.yml
  tags:
    - amibuild
    - ec2provision
    - create_slack_notification_package

- import_tasks: setup_scripted_notifications.yml
  tags:
    - amibuild
    - ec2provision
    - setup_scripted_notifications

- import_tasks: configure_ssh.yml
  tags:
    - amibuild
    - ec2provision
    - configure_ssh
