---
- name: Apply Supplementary Patches
  vars:
    ru_phase: "pre"  # Set to "pre" or "post" when calling the task
    phase_variable: "{{ ru_phase }}_ru_patch"
  block:

    - name: Download patches
      amazon.aws.aws_s3:
        bucket: "{{ artefacts_s3_bucket_name }}"
        object: "{{ artefacts_s3_bucket_path }}/{{ item.value.patch_files.filename }}"
        dest: "{{ omspatcher_stage }}/{{ item.value.patch_files.filename }}"
        mode: get
        permission: "public-read"
        overwrite: latest
      loop: "{{ required_patches | dict2items }}"
      when: "item.value[phase_variable] | default(false)"
      loop_control:
        label: "{{ item.key }}"

    - name: Extract patches 
      ansible.builtin.unarchive:
        src: "{{ omspatcher_stage }}/{{ item.value.patch_files.filename }}"
        dest: "{{ omspatcher_stage }}"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        remote_src: yes
      loop: "{{ required_patches | dict2items }}"
      when: "item.value[phase_variable] | default(false)"
      loop_control:
        label: "{{ item.key }}"

    - name: Check if patches are already applied
      shell: |
        ${ORACLE_HOME}/OPatch/opatch lsinventory | grep {{ item.key.split('p')[1] }} | wc -l
      register: patch_status
      changed_when: false
      failed_when: false
      loop: "{{ required_patches | dict2items }}"
      when: "item.value[phase_variable] | default(false)"
      loop_control:
        label: "{{ item.key }}"

    - name: Debug patch status
      debug:
        var: patch_status

    # The fuser utility is not installed as a matter of course so we set OPATCH_NO_FUSER to workaround this
    - name: Apply patches if not already applied
      shell: |
        export PATH=$PATH:${ORACLE_HOME}/bin 
        export OPATCH_NO_FUSER=true
        cd {{ omspatcher_stage }}/{{ item.key.split('p')[1] }}
        ${ORACLE_HOME}/OPatch/opatch apply -silent
      register: run_opatch
      async: 1200
      poll: 0
      when: 
        - (patch_status.results | selectattr('item.key', 'equalto', item.key) 
          | selectattr('skipped', 'equalto', false) 
          | map(attribute='stdout') | first | default('') | int) == 0
        - item.value[phase_variable] | default(false)
      loop: "{{ required_patches | dict2items }}"
      loop_control:
        label: "{{ item.key }}"

    - name: Wait for OPatch Install
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: result
      until: result.finished
      retries: 80
      delay: 30
      when:
        - item.value[phase_variable] | default(false)
        - item.ansible_job_id is defined
      loop: "{{ run_opatch.results | selectattr('skipped', 'equalto', false) }}"
      loop_control:
        label: "{{ item.item.key }}"

  # block
  become: true
  become_user: "{{ oracle_install_user }}"
  environment: "{{ oms_env }}"