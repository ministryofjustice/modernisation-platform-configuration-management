---
- name: Collect file details for cleanup from {{ stage }}
  ansible.builtin.find:
    path: "{{ stage }}"
    hidden: True
  register: collected_files

- name: Collect directory details for cleanup from {{ stage }}
  ansible.builtin.find:
    paths: "{{ stage }}"
    hidden: True
    file_type: directory
  register: collected_directories

- name: remove collected files and directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  with_items: >
    {{
      collected_files.files
      + collected_directories.files
    }}

- name: OMS Cleanup
  block:
    - name: Remove OMSPatcher Property File
      file:
        path: "{{ omspatcher_stage }}/oms_property_file"
        state: absent

    - name: Check status of OMS
      ansible.builtin.shell: |
        {{ emctl_oms }} status oms | grep -c "^Oracle Management Server is Up" | cat
      changed_when: false
      register: oms_running

    - name: Re-Start OMS After Patching
      ansible.builtin.shell: |
        set -eo pipefail
        main() {
          {{ emctl_oms }} start oms
        }
        main 2>&1 | logger -p local3.info -t ansible-oracle-oem
      async: 86400
      poll: 60
      when: oms_running.stdout == '0'
  # block
  become: true
  become_user: oracle
  environment: "{{ oms_env }}"
