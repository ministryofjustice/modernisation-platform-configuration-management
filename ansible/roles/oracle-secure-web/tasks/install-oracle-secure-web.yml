---
- name: Fail if IAM profile not defined
  fail:
    msg: "Please run get-ec2-facts role to collect facts"
  when: ansible_ec2_iam_instance_profile_role is not defined

- name: Unpack install files
  ansible.builtin.unarchive:
    owner: oracle
    group: oinstall
    src: "{{ osw_installfiles_dir }}/{{ item }}"
    dest: "{{ osw_install_dir }}"
    remote_src: yes
  loop:
    - jdk-7u80-linux-x64.tar.gz
    - osbws_installer.zip

- name: Configure osbws_argfile
  ansible.builtin.template:
    src: osbws_argfile
    dest: "{{ osw_install_dir }}/osbws_argfile"
    mode: 0644
    owner: oracle
    group: oinstall

- name: Copy install script
  ansible.builtin.template:
    src: install.sh
    dest: "{{ osw_install_dir }}/install.sh"
    mode: 0755
    owner: oracle
    group: oinstall

- name: Run install script
  become_user: oracle
  shell: |
    {{ osw_install_dir }}/install.sh

- name: Update osbws config
  become_user: oracle
  ansible.builtin.lineinfile:
    path: "{{ oracle_home }}/dbs/osbws.ora"
    line: "OSB_WS_BUCKET={{ ansible_aws_ssm_bucket_name }}"
    create: yes

- name: Run test
  become_user: oracle
  shell: |
    export OSB_WS_PFILE={{ oracle_home }}/dbs/osbws.ora
    {{ oracle_home }}/bin/sbttest /tmp/foo -libname {{ oracle_home }}/lib/libosbws.so
