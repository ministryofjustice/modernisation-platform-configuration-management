- name: Download Response File from S3
  aws_s3:
    mode: get
    bucket: "{{ s3.bip_bucket_name }}"
    object: "{{ s3.prefix }}{{ s3.files.tomcat_admin_response_file }}"
    dest: "{{ sap_bi_platform_extraction_directory }}/response.ini"
    overwrite: true

- name: Get key and password from parameter store
  set_fact:
    cms_password: "{{ lookup('aws_ssm', '/ec2/tomcat-webserver/CMS', region='eu-west-2') }}"
    product_key: "{{ lookup('aws_ssm', '/ec2/tomcat-webserver/product-key', region='eu-west-2') }}"
  ignore_errors: true

- name: Ensure product key is set in response file
  ansible.builtin.lineinfile:
    path: "{{ sap_bi_platform_extraction_directory }}/response.ini"
    regexp: '^productkey='
    line: "productkey={{ product_key }}"

- name: Ensure CMS password is set in response file
  ansible.builtin.lineinfile:
    path: "{{ sap_bi_platform_extraction_directory }}/response.ini"
    regexp: '^remotecmsadminpassword='
    line: "remotecmsadminpassword={{ cms_password }}"