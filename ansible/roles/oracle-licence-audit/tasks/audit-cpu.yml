- name: Set up audit directory
  block:
    - name: Create work directory on remote host
      file:
        path: "{{ audit_dir }}"
        state: directory
        owner: oracle
        mode: "777"

    - name: Download utility shell scripts to {{ audit_dir }}
      copy:
        src: "{{ item }}"
        dest: "{{ audit_dir }}/{{ item }}"
        mode: "0755"
      loop:
        - cpuq.sh

- name: CPU auditing
  block:
    - name: Check if cpuq.sh script exists
      stat:
        path: "{{ audit_dir }}/cpuq.sh"
      register: cpuq_stat

    - name: Execute cpu script
      shell: |
        cd {{ audit_dir }}
        echo 'y' | ./cpuq.sh {{ audit_dir }} > /dev/null 2>&1
      register: cpuout

    - name: Fetch cpu output files
      fetch:
        src: "{{ audit_dir }}/{{ inventory_hostname }}-ct_cpuq.txt"
        dest: "{{ audit_dir }}/"
        flat: yes

    - name: Get instance ID using instance metadata (on remote EC2)
      shell: curl -s http://169.254.169.254/latest/meta-data/instance-id
      register: ec2_instance_id

    - name: Set instance ID fact for later use
      set_fact:
        instance_id: "{{ ec2_instance_id.stdout }}"

    - name: Get CPU options from AWS CLI (CoreCount and ThreadsPerCore)
      delegate_to: localhost
      become: no
      shell: |
        aws ec2 describe-instances \
          --instance-ids {{ instance_id }} \
          --query "Reservations[].Instances[].CpuOptions" \
          --region {{ region }} --output json > {{ audit_dir }}/{{ inventory_hostname }}-vcpus.txt

