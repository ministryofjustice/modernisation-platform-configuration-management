- name: Audit weblogic cluster
  block:

    - name: Initialise weblogic dictionaries
      set_fact:
        weblogic_info: {}
        weblogic_temp_info: {}
        weblogic_cluster: "{{ environment_name }}-cluster"

    - name: Get number of registered container instances in cluster
      delegate_to: localhost
      become: no
      shell: >
        aws ecs describe-clusters --clusters {{ weblogic_cluster }} --region {{ region }} | jq -r '.clusters[].registeredContainerInstancesCount'
      register: container_count
      changed_when: false

    - name: Process weblogic services if container instances exist
      when: container_count.stdout | int > 0
      block:

        - name: List weblogic services
          delegate_to: localhost
          become: no
          shell: >
            aws ecs list-services --cluster {{ weblogic_cluster }} --region {{ region }} | jq -r '.serviceArns[]' | egrep -- "weblogic" | awk -F'/' '{print $NF}'
          register: weblogic_services
          changed_when: false

        - name: Process each weblogic service
          when: weblogic_services.stdout_lines | length > 0
          block:

            # ------------------------------------------------------------
            # LICENSING LOGIC â€” UNIQUE CONTAINER INSTANCES
            # ------------------------------------------------------------

            - name: Collect RUNNING task ARNs for all weblogic services
              delegate_to: localhost
              become: no
              shell: >
                aws ecs list-tasks --cluster {{ weblogic_cluster }} --service-name {{ item }} --desired-status RUNNING --region {{ region }} | jq -r '.taskArns[]?'
              loop: "{{ weblogic_services.stdout_lines }}"
              register: weblogic_task_arns_by_service
              changed_when: false

            - name: Flatten task ARNs
              set_fact:
                weblogic_task_arns: >-
                  {{
                    weblogic_task_arns_by_service.results
                    | map(attribute='stdout_lines')
                    | list
                    | flatten
                  }}

            - name: Chunk task ARNs for describe-tasks (max 100)
              set_fact:
                weblogic_task_chunks: "{{ weblogic_task_arns | batch(100) | list }}"
              when: weblogic_task_arns | length > 0

            - name: Resolve container instance ARNs from tasks
              delegate_to: localhost
              become: no
              shell: >
                aws ecs describe-tasks --cluster {{ weblogic_cluster }} --tasks {{ item | join(' ') }} --region {{ region }} | jq -r '.tasks[].containerInstanceArn?'
              loop: "{{ weblogic_task_chunks }}"
              register: weblogic_ci_arns_raw
              changed_when: false
              when: weblogic_task_arns | length > 0

            - name: Deduplicate container instance ARNs
              set_fact:
                weblogic_container_instances: >-
                  {{
                    weblogic_ci_arns_raw.results
                    | map(attribute='stdout_lines')
                    | list
                    | flatten
                    | unique
                  }}
              when: weblogic_task_arns | length > 0

            - name: Chunk container instances for describe-container-instances
              set_fact:
                weblogic_ci_chunks: "{{ weblogic_container_instances | batch(100) | list }}"
              when: weblogic_task_arns | length > 0

            - name: Get EC2 instance IDs from container instances
              delegate_to: localhost
              become: no
              shell: >
                aws ecs describe-container-instances --cluster {{ weblogic_cluster }} --container-instances {{ item | join(' ') }} --region {{ region }} | jq -r '.containerInstances[].ec2InstanceId'
              loop: "{{ weblogic_ci_chunks }}"
              register: weblogic_instance_data
              changed_when: false
              when: weblogic_task_arns | length > 0

            - name: Flatten EC2 instance IDs
              set_fact:
                weblogic_ec2_ids: >-
                  {{
                    weblogic_instance_data.results
                    | map(attribute='stdout_lines')
                    | list
                    | flatten
                  }}
              when: weblogic_task_arns | length > 0

            - name: Chunk EC2 instance IDs for describe-instances (max 100)
              set_fact:
                weblogic_ec2_chunks: "{{ weblogic_ec2_ids | batch(100) | list }}"
              when: weblogic_task_arns | length > 0

            - name: Get instance types from EC2
              delegate_to: localhost
              become: no
              shell: >
                aws ec2 describe-instances --instance-ids {{ item | join(' ') }} --region {{ region }} | jq -r '.Reservations[].Instances[] | "\(.InstanceId):\(.InstanceType)"'
              loop: "{{ weblogic_ec2_chunks }}"
              register: weblogic_ec2_types_raw
              changed_when: false
              when: weblogic_task_arns | length > 0

            - name: Flatten EC2 instance type data
              set_fact:
                weblogic_ec2_types: >-
                  {{
                    weblogic_ec2_types_raw.results
                    | map(attribute='stdout_lines')
                    | list
                    | flatten
                  }}
              when: weblogic_task_arns | length > 0

            - name: Build instance type list
              set_fact:
                weblogic_instance_types: >-
                  {{
                    weblogic_ec2_types
                    | map('regex_replace', '^.+:(.+)$', '\\1')
                    | list
                  }}
              when: weblogic_task_arns | length > 0

            - name: Get unique instance types
              set_fact:
                weblogic_unique_types: "{{ weblogic_instance_types | unique | sort }}"
              when: weblogic_task_arns | length > 0

            - name: Get vCPU counts for each unique instance type
              delegate_to: localhost
              become: no
              shell: >
                aws ec2 describe-instance-types --instance-types {{ weblogic_unique_types | join(' ') }} --region {{ region }} | jq -r '.InstanceTypes[] | "\(.InstanceType):\(.VCpuInfo.DefaultVCpus)"'
              register: weblogic_vcpu_info
              changed_when: false
              when: weblogic_task_arns | length > 0

            - name: Build instance type summary
              set_fact:
                instance_type_counts: >-
                  {%- set counts = {} -%}
                  {%- for itype in weblogic_instance_types -%}
                    {%- set _ = counts.update({itype: counts.get(itype, 0) + 1}) -%}
                  {%- endfor -%}
                  {{ counts }}
                instance_type_vcpus: >-
                  {%- set vcpus = {} -%}
                  {%- for line in weblogic_vcpu_info.stdout_lines -%}
                    {%- set parts = line.split(':') -%}
                    {%- set _ = vcpus.update({parts[0]: parts[1] | int}) -%}
                  {%- endfor -%}
                  {{ vcpus }}
              when: weblogic_task_arns | length > 0

            - name: Create instance type summary string
              set_fact:
                instance_type_summary: >-
                  {%- set items = [] -%}
                  {%- for itype in instance_type_counts.keys() | list | sort -%}
                    {%- set _ = items.append(itype ~ '(' ~ (instance_type_counts[itype] | default(0)) ~ ')') -%}
                  {%- endfor -%}
                  {{ items | join(', ') }}
                instance_vcpu_summary: >-
                  {%- set items = [] -%}
                  {%- for itype in instance_type_vcpus.keys() | list | sort -%}
                    {%- set _ = items.append(itype ~ ':' ~ (instance_type_vcpus[itype] | default(0))) -%}
                  {%- endfor -%}
                  {{ items | join(', ') }}
              when: weblogic_task_arns | length > 0

            - name: Calculate total vCPUs used by weblogic (licensing basis)
              set_fact:
                total_vcpus_used: >-
                  {%- set ns = namespace(total=0) -%}
                  {%- for itype in instance_type_counts.keys() -%}
                    {%- set count = instance_type_counts[itype] | int -%}
                    {%- set vcpus = instance_type_vcpus[itype] | int -%}
                    {%- set ns.total = ns.total + (count * vcpus) -%}
                  {%- endfor -%}
                  {{ ns.total }}
              when: weblogic_task_arns | length > 0

            - name: Default vCPU usage to zero if no tasks running
              set_fact:
                total_vcpus_used: 0
                instance_type_summary: "none"
                instance_vcpu_summary: "none"
              when: weblogic_task_arns | length == 0

            # ------------------------------------------------------------
            # OUTPUT
            # ------------------------------------------------------------

            - name: Populate weblogic audit dictionary
              set_fact:
                weblogic_info: >-
                  {{
                    weblogic_info | combine({
                      environment_name: {
                        'cluster': weblogic_cluster,  
                        'container_instances': (weblogic_container_instances | length) if (weblogic_task_arns | length > 0) else 0,
                        'instance_type': instance_type_summary,
                        'instance_type_vcpu_count': instance_vcpu_summary,
                        'total_vcpus_used': total_vcpus_used | int
                      }
                    })
                  }}

            - name: Remove old weblogic results file
              delegate_to: localhost
              become: no
              file:
                path: "{{ weblogic_cluster_output }}"
                state: absent

            - name: Create audit directory
              delegate_to: localhost
              become: no
              file:
                path: "{{ audit_dir }}"
                state: directory

            - name: Create weblogic results file
              delegate_to: localhost
              become: no
              file:
                path: "{{ weblogic_cluster_output }}"
                state: touch

            - name: Set headings in weblogic results file
              delegate_to: localhost
              become: no
              lineinfile:
                path: "{{ weblogic_cluster_output }}"
                line: "Environment:InstanceType(Count):InstanceType:VcpuCount:ContainerInstances:TotalVcpuUsed"

            - name: Write results to local file
              delegate_to: localhost
              become: no
              lineinfile:
                path: "{{ weblogic_cluster_output }}"
                line: "{{ item.key }}:{{ item.value.instance_type }}:{{ item.value.instance_type_vcpu_count }}:{{ item.value.container_instances }}:{{ item.value.total_vcpus_used }}"
              with_dict: "{{ weblogic_info }}"


            - name: Total up number for weblogic vcpu's
              set_fact:
                total_vcpu: "{{ total_vcpu | default(0) | int + item.value.total_vcpus_used | int }}"
              with_dict: "{{ weblogic_info }}"

            - name: Copy vcpu total to local file
              delegate_to: localhost
              become: no
              lineinfile:
                path: "{{ weblogic_cluster_output }}"
                line: "vCPU Total: {{ total_vcpu | default(0) | int }}"

            - name: Upload audit results
              when: upload_collection | default(true) | bool
              delegate_to: localhost
              become: no
              shell: >
                aws s3 cp {{ weblogic_cluster_output }} s3://{{ bucket_name }}/{{ audit_output }}/ --acl bucket-owner-full-control {{ general_kms_key_option }}

  when:
    - environment_name is defined
    - environment_name != ""