# tasks/audit-instance.yml
- name: Set fact for SQL output folder
  set_fact:
    sql_output_dir: "{{ audit_dir }}/{{ inventory_hostname }}_{{ db_name }}"

- name: Create per-DB work directory
  file:
    path: "{{ sql_output_dir }}"
    state: directory
    owner: oracle
    mode: "0755"

- name: Execute Oracle ReviewLite23.3.sql
  shell: |
    . ~/.bash_profile
    export ORACLE_SID={{ db_name }}
    export ORAENV_ASK=NO
    . oraenv <<< "{{ db_name }}"
    cd {{ audit_dir }}
    sqlplus -s / as sysdba << EOF
      @ReviewLite23.3.sql
      exit
    EOF
  become: yes
  become_method: sudo
  become_user: oracle
  register: sqlout

- name: Execute other Oracle scripts
  shell: |
    . ~/.bash_profile
    export ORACLE_SID={{ db_name }}
    export ORAENV_ASK=NO
    . oraenv <<< "{{ db_name }}"
    cd {{ sql_output_dir }}
    sqlplus -s / as sysdba << EOF
      @../options_packs_usage_statistics.sql
      @../options_packs_usage_summary.sql
      exit
    EOF
  become: yes
  become_method: sudo
  become_user: oracle
  register: sqlout

- name: Create database directory on controller
  delegate_to: localhost
  become: no
  file:
    path: "{{ sql_output_dir }}"
    state: directory

- name: Find database output files
  find:
    path: "{{ sql_output_dir }}"
    recurse: yes
    patterns:
      - "*.csv"
      - "*.txt"
  register: database_output_files

- name: Fetch database output files
  fetch:
    src: "{{ item.path }}"
    dest: "{{ sql_output_dir }}/"
    flat: yes
  with_items: "{{ database_output_files.files }}"