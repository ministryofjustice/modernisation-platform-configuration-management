---
- name: Set SSM parameters paths
  set_fact:
    ssm_parameters_path_az_sas_token: "/database/{{ ec2.tags.Name }}/az_sas_token"

- name: Get Egress Ip
  ansible.builtin.shell: |
    curl https://ipecho.net/plain
  register: internet_egress_ip
  check_mode: false
  changed_when: false

- debug:
    msg: "{{ internet_egress_ip.stdout }} must be allowed in dso-infra-azure-fixngo:terragrunt/NOMSProduction1/pd-noms-azcopy-orabkup/terraform.tfvars"

- debug:
    msg: "SAS token must be uploaded {{ ssm_parameters_path_az_sas_token }}, use modernisation-platform-environments:/environments/nomis/scripts/update-db-az-sas-token.sh"

- name: Get SSM parameters
  set_fact:
    oracle_db_restore_az_sas_token: "{{ lookup('aws_ssm', ssm_parameters_path_az_sas_token, region=ansible_ec2_placement_region) }}"

# move these facts into defaults / group_vars
- set_fact:
    oracle_db_restore_local_path: "/u02/DB_BKP"
    oracle_db_restore_az_storage_account_name: strpdnomsazcopyorabkup
    oracle_db_restore_az_path: pdpdl00035-cnomp
    oracle_db_restore_az_files:
      - "CNOMP_pp.log"
      - "afiedt.buf"

- name: Create db restore directory
  ansible.builtin.file:
    path: "{{ oracle_db_restore_local_path }}/{{ oracle_db_restore_az_path }}"
    state: directory

- name: Download backup files
  ansible.builtin.shell: |
    azcopy cp \
      "https://{{ oracle_db_restore_az_storage_account_name }}.blob.core.windows.net/{{ oracle_db_restore_az_path }}/{{ item }}?{{ oracle_db_restore_az_sas_token }}" \
      "{{ oracle_db_restore_local_path }}/{{ oracle_db_restore_az_path }}/{{ item }}" \
      --overwrite=ifSourceNewer
  loop: "{{ oracle_db_restore_az_files }}"
