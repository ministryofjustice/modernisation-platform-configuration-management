---
# install xfsprogs
- name: install xfsprogs
  yum:
    name: xfsprogs
    state: present

# cd /u02/stage/ORDS
# list keys in an AWS S3 bucket
- name: list keys in an AWS S3 bucket
  aws_s3:
    bucket: "{{ oasys_ords_s3_bucket }}"
    mode: list
  register: s3_keys

# mirror an AWS S3 bucket
- name: mirror an AWS S3 bucket
  aws_s3:
    bucket: "{{ oasys_ords_s3_bucket }}"
    object: "{{ item }}"
    dest: "{{ /tmp/{{ item }} }}"
    mode: get
  loop: "{{ s3_keys.files }}"
  when: s3_keys is defined

# unzip ords-19.4.6.142.1859.zip -d /u02/stage/ORDS/ords_stage
- name: unzip ords-19.4.6.142.1859.zip
  unarchive:
    src: "{{ /tmp/ords-19.4.6.142.1859.zip }}"
    dest: "{{ oasys_ords_dir }}"
    remote_src: yes
  loop: "{{ s3_keys.files }}"
  when: s3_keys is defined

# cd /u01/app/apache/tomcat
# make directory for tomcat
- name: create apache tomcat directory
  file:
    path: /u01/app/apache/tomcat
    state: directory
    owner: oracle
    group: dba
    mode: 0755

# tar -xzvf /u02/stage/ORDS/jre-9.0.4_linux-x64_bin.tar.gz
# untar jre-9.0.4_linux-x64_bin.tar.gz
- name: untar jre-9.0.4_linux-x64_bin.tar.gz
  unarchive:
    src: "{{ /tmp/jre-9.0.4_linux-x64_bin.tar.gz }}"
    dest: /u01/app/apache/tomcat
    remote_src: yes
  loop: "{{ s3_keys.files }}"
  when: s3_keys is defined

# tar -xzvf /u02/stage/ORDS/apache-tomcat-9.0.13.tar.gz
# untar apache-tomcat-9.0.13.tar.gz
- name: untar apache-tomcat-9.0.13.tar.gz
  unarchive:
    src: "{{ /tmp/apache-tomcat-9.0.13.tar.gz }}"
    dest: /u01/app/apache/tomcat
    remote_src: yes
  loop: "{{ s3_keys.files }}"
  when: s3_keys is defined

# ln -s apache-tomcat-9.0.13 latest
# create symbolic link for tomcat
- name: create symbolic link for tomcat
  file:
    src: /u01/app/apache/tomcat/apache-tomcat-9.0.13
    dest: /u01/app/apache/tomcat/latest
    state: link
    owner: oracle
    group: dba #replace with dba ###
    mode: 0755

# cd /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps
# cp -p /u02/stage/ORDS/ords_stage/ords.war eor.war
# copy ords.war to eor.war
- name: copy ords.war to eor.war
  copy:
    src: "{{ oasys_ords_dir }}/ords.war"
    dest: /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps/eor.war
    owner: oracle
    group: dba
    mode: 0755

# cp -Rp /u02/stage/ORDS/ords_stage/params .
# copy params to /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps
- name: copy params to /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps
  copy:
    src: "{{ oasys_ords_dir }}/params"
    dest: /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps
    owner: oracle
    group: dba
    mode: 0755

# # mkdir i
# # create directory i
# - name: create directory i
#   file:
#     path: /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps/i
#     state: directory
#     owner: oracle
#     group: dba
#     mode: 0755

# # cd i
# # cp -Rp /u01/app/oracle/product/11.1.1/as_1/instances/oasysr1/config/OHS/oasysr_ohs1/images/* .
# # copy images to /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps/i
# - name: copy images to /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps/i
#   copy:
#     src: "{{ oasys_ords_dir }}/images"
#     dest: /u01/app/apache/tomcat/apache-tomcat-9.0.13/webapps/i
#     owner: oracle
#     group: dba
#     mode: 0755

# add startup and shutdown scripts
- name: add startup and shutdown scripts
  copy:
    src: "files/home/oracle/admin/scripts/{{ item }}"
    dest: "/home/oracle/admin/scripts/{{ item }}"
    owner: oracle
    group: dba
    mode: 0755
  loop:
    - tomcat_startup_service.sh
    - tomcat_shutdown_service.sh
