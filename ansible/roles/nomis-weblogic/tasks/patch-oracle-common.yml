---
- name: Fail if required weblogic patch variables not defined
  fail:
    msg: "Error, please ensure forms_patch_filename and forms_patch_id are defined"
  when: forms_patch_filename is not defined or forms_patch_id is not defined

- name: Get current Oracle common patch
  become_user: oracle
  ansible.builtin.shell: |
    . ~/.bash_profile > /dev/null
    export ORACLE_HOME=/u01/app/oracle/Middleware/oracle_common
    opatch lspatches -id {{ forms_patch_id }} || true
  changed_when: false
  register: forms_lspatches
  failed_when:
    - not forms_lspatches.stdout is search('applied_date')
    - not forms_lspatches.stdout is search('NOT registered')

- name: Install oracle common patch
  when: not forms_lspatches.stdout is search('applied_date')
  block:
    - import_tasks: extract-s3-archive.yml
      vars:
        weblogic_s3_archives:
          - "{{ forms_patch_filename }}"

    - name: Stop services if not already running
      ansible.builtin.service:
        name: weblogic-all
        state: stopped

    - name: Run oracle common patch script which takes approx 20 mins
      become_user: oracle
      ansible.builtin.shell: |
        set -eo pipefail
        . ~/.bash_profile
        export ORACLE_HOME=/u01/app/oracle/Middleware/oracle_common
        main() {
          cd "{{ forms_patch_filename.split('/')[:-1] | join('/') }}/{{ forms_patch_id }}"
          $ORACLE_HOME/OPatch/opatch apply -silent 
        }
        main 2>&1 | logger -p local3.info -t ansible-weblogic
