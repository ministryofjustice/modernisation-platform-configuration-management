---
- name: Get facts for playbook execution
  ansible.builtin.import_tasks: get_facts.yml
  tags:
    - always

- name: Remove keepalive
  ansible.builtin.import_tasks: rename_keepalive_start_outage.yml
  when: app_server_file.stat.exists
  tags:
    - start_outage

- name: Stop_nomis_weblogic
  ansible.builtin.import_tasks: stop_nomis_app.yml
  when: app_server_file.stat.exists
  tags:
    - stop_application

- name: Create oracle restore point before release deployment 
  ansible.builtin.include_role:
    name: oracle-restore-point
    apply:
      tags: 
        - create_restore_point
  vars:
    restore_point_name: "{{ restore_point_name }}"
    db_tns_list: "{{ db_tns_list }}"
    action: create
  tags: 
    - create_restore_point

# - name: Stop streams (Import oracle-streams role, WIP)

- name: APP - Copy script to deploy release on application server
  ansible.builtin.template:
    src: "tag_release_deployment.sh.j2"
    dest: "{{ stage }}/tag_release_deployment.sh"
    mode: 0700
    owner: "{{ oracle_install_user }}"
    group: "{{ oracle_install_group }}"
  when: app_server_file.stat.exists
  tags:
    - deploy_release

- name: APP - Copy script to compile single form
  ansible.builtin.template:
    src: "compform.sh.j2"
    dest: "/u01/tag/utils/scripts/compform.sh"
    mode: 0700
    owner: "{{ oracle_install_user }}"
    group: "{{ oracle_install_group }}"
  when: app_server_file.stat.exists
  tags:
    - deploy_release

- name: Deploy nomis releases
  ansible.builtin.include_tasks:
    file: nomis_deploy_release.yml
    apply:
      tags:
        - deploy_release
  loop_control:
    loop_var: nomis_release
  loop: "{{ nomis_releases }}"
  tags:
    - deploy_release

- name: Start Nomis weblogic app
  ansible.builtin.import_tasks: start_nomis_app.yml
  when: app_server_file.stat.exists
  tags:
    - start_application

- name: Rename keepalive back to end outage
  ansible.builtin.import_tasks: rename_keepalive_end_outage.yml
  when: app_server_file.stat.exists
  tags:
    - end_outage

# - name: Start streams (Import oracle-streams role, WIP)

- name: Drop oracle restore point post successful validation
  ansible.builtin.include_role:
    name: oracle-restore-point
    apply:
      tags: 
        - drop_restore_point
  vars:
    restore_point_name: "{{ restore_point_name }}"
    db_tns_list: "{{ db_tns_list }}"
    action: drop
  tags: 
    - drop_restore_point
