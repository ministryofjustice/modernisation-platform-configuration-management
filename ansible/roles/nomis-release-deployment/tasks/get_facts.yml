---
- name: Check server has DB components
  ansible.builtin.stat:
    path: /etc/oratab
  register: db_server_file

- name: Check server has APP components
  ansible.builtin.stat:
    path: /u01/app/oracle/Middleware/user_projects/domains/NomisDomain
  register: app_server_file

- name: DB servers facts
  block:
    - name: If database server , get DB name from running process
      ansible.builtin.shell: ps -ef | grep pmon | grep NOM| grep -v grep | awk -F_ '{ print $3 }'
      changed_when: false
      check_mode: false
      register: db_name

    - name: Set db name from ec2 oracle-db-name tag
      set_fact:
        app_db_name: "{{ db_name.stdout }}"

  # block
  when: db_server_file.stat.exists

- name: Get secretsmanager passwords
  block:
    - name: secretsmanager passwords
      import_role:
        name: secretsmanager-passwords
      vars:
        secretsmanager_passwords: "{{ app_secretsmanager_passwords }}"

    - name: secretsmanager passwords
      set_fact:
        app_db_password: "{{ secretsmanager_passwords_dict['db'].passwords[app_db_username] }}"

  when: not use_ssm_params
  

- name: Get SSM params
  block:
    - name: Get SSM parameters
      import_role:
        name: ssm-passwords
      vars:
        ssm_passwords: "{{ app_ssm_passwords }}"

    - name: Get SSM parameters
      set_fact:
        app_db_password: "{{ ssm_passwords_dict['db'].passwords[app_db_username] }}"
      when: ssm_passwords_dict is defined

  when: use_ssm_params

- name: Check all secrets and tags are set
  set_fact:
    app_all_variables_set: true
  when:
    - app_db_username|length > 0
    - app_db_password|length > 0
    - app_db_name|length > 0

- name: Fail if missing SSM parameters or tags
  fail:
    msg: Ensure all required SSM parameters and tags are set
  when: not app_all_variables_set|default(false)
