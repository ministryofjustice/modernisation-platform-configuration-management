---
- name: Copy validation script
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ stage }}/{{ item }}"
    owner: "{{ oracle_install_user }}"
    group: "{{ oracle_install_group }}"
    mode: "0700"
  loop:
    - "validate_target_db.sh"

# Don't log the command output as it contains sensitive information
- name: Check database is in ARCHIVELOG mode.
  ansible.builtin.shell: |
    echo "{{ db_sys_password }}" | {{ stage }}/validate_target_db.sh {{ target_host }} {{ target_db }} > {{ stage }}/tmp_output_file.out 2>&1
  no_log: true
  register: script_result
  ignore_errors: true # Let us inspect output even if the command fails

- name: Read script output
  ansible.builtin.slurp:
    src: "{{ stage }}/tmp_output_file.out"
  register: script_output_raw

- name: Decode and show script output
  debug:
    msg: "{{ script_output_raw.content | b64decode }}"

- name: Delete temporary output file
  ansible.builtin.file:
    path: "{{ stage }}/tmp_output_file.out"
    state: absent

- name: Fail task if script errored
  ansible.builtin.fail:
    msg: "Secure script failed with return code {{ script_result.rc }}"
  when: script_result.rc != 0
