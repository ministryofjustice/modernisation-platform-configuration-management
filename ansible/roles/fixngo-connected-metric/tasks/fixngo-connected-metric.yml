---
- name: create folder for exec script to collect metrics
  ansible.builtin.file:
    path: "/opt/collectd"
    state: directory
    owner: root
    group: root
    mode: 0755

# format must be "x.x.x.x port x.x.x.x port x.x.x.x port ..."
- name: get fact for fixngo connection targets
  set_fact:
    fixngo_connection_targets: "{{ ec2.tags['fixngo-connection-targets'] }}"

- name: list of lists
  set_fact:
    fixngo_connection_targets_list: "{{ fixngo_connection_targets.split(' ') | slice(2) | map('list') | list }}"

- name: create dictionary of lists
  set_fact:
    fixngo_connection_targets_dict: "{{ fixngo_connection_targets_dict | default([]) + [{'ip': item.0, 'port': item.1 }] }}"
  loop: "{{ fixngo_connection_targets_list }}"

- name: add fixngo conf for collectd to get connection state as a metric
  ansible.builtin.copy:
    src: fixngo.conf
    dest: "/etc/collectd.d/fixngo.conf"
    owner: root
    mode: 0755

- name: Add fixngo connected check script
  ansible.builtin.template:
    src: fixngo_connected_metrics.sh.j2
    dest: /opt/collectd/fixngo_connected_metrics.sh
    mode: 0755
  notify: restart collectd
