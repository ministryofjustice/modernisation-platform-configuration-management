---
# sets up the monitoring for misload using collectd exec plugin and posting messages to /var/log/messages
- name: set fact get misload database name
  set_fact:
    misload_db_name: "{{ ((ec2.tags['oracle-sids']).split(' ') | select('match', '.*MIS.*') | list) | join(' ') }}"

- name: debug misload_db_name
  ansible.builtin.debug:
    msg: "{{ misload_db_name }}"

- name: create script directory
  ansible.builtin.file:
    path: "{{ item }}"
    owner: oracle
    group: oinstall
    state: directory
    recurse: yes
  loop:
    - /home/oracle/admin/misload_scripts/logs
    - /home/oracle/admin/misload_scripts/status

- name: copy monitoring scripts
  template:
    src: "{{ item }}.j2"
    dest: "/home/oracle/admin/misload_scripts/{{ item }}"
    owner: oracle
    group: oinstall
    mode: "0700"
  loop:
    - "{{ misload_monitoring_script }}"

- name: setup misload monitoring root cron
  ansible.builtin.cron:
    name: "{{ item.name }}"
    weekday: "{{ item.weekday }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    user: root
    job: "{{ item.job }}"
  loop: "{{ misload_monitoring_cron }}"
