---
- name: Install amazon-cloudwatch-agent
  ansible.builtin.yum:
    name: "{{ amazon_cloudwatch_agent_package }}"

- name: Create amazon-cloudwatch-agent config directory
  ansible.builtin.file:
    path: "{{ amazon_cloudwatch_agent_config_path }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Set up collectd for monitoring oracle db connections
  block:
    - name: Ensure the EPEL repository is available
      ansible.builtin.package:
        name: epel-release
        state: installed
      register: epel_release_installed
      ignore_errors: true

    - name: Add epel-release to repolist
      ansible.builtin.shell: |
        yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
      when: epel_release_installed is failed

    - name: Install collectd agent
      ansible.builtin.yum:
        name: collectd
        state: present

    - name: Get oracle database sids for monitoring as a list from the oracle-sids tag
      set_fact:
        oracle_sid_list: '{{ ec2.tags["oracle-sids"].split() | default([]) | join(" ") }}'

    - name: Get tag values for use in tagging metrics
      set_fact:
        name: '{{ ec2.tags["Name"] }}'
        server-type: '{{ ec2.tags["server-type"] }}'

    - name: add custom types file for oracle_health.sh
      ansible.builtin.copy:
        src: types.db.custom
        dest: /usr/share/collectd/types.db.custom
        owner: root
        mode: 0644

    - name: Configure collectd # TODO: make this reload the service if/when it changes
      ansible.builtin.template:
        src: collectd.conf.j2
        dest: "/etc/collectd.conf"
        owner: root
        mode: 0644

    - name: create folder for exec script to collect metrics
      ansible.builtin.file:
        path: "/opt/collectd"
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: Add oracle_health check script
      ansible.builtin.template:
        src: oracle_health.sh.j2
        dest: /opt/collectd/oracle_health.sh
        mode: 0500
        owner: oracle

    - name: Make Oracle Health Check script executable
      ansible.builtin.shell: |
        chmod +x /opt/collectd/oracle_health.sh

    - name: Start collectd service
      ansible.builtin.service:
        name: collectd
        state: started
        enabled: yes

  when: ec2.tags['oracle-sids'] is defined

- name: Create amazon-cloudwatch-agent config file
  ansible.builtin.template:
    src: "{{ amazon_cloudwatch_config_template_path }}"
    dest: "{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_config_file }}"
    owner: root
    group: root
    mode: 0644

- name: Start amazon-cloudwatch-agent service
  ansible.builtin.shell: |
    /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:"{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_config_file }}"
