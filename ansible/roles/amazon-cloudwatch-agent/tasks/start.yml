---
# covers cloudwatch agent start for linux (common) and oracle EC2 instances
- name: Start amazon-cloudwatch-agent service
  ansible.builtin.shell: |
    /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:"{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_config_file }}"

- name: Append settings for collectd to amazon-cloudwatch-agent config file
  ansible.builtin.shell: |
    /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -s -c file:"{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_collectd_config_file }}"
  when: collectd_installed.rc == 0

# additional settings for weblogic EC2 instances
- name: Append settings for amazon-cloudwatch-agent for weblogic EC2 instances
  ansible.builtin.shell: |
    /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -s -c file:"{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_weblogic_config_file }}"
  when: ec2.tags['server-type'] == 'nomis-web'