---
# covers cloudwatch agent start for linux (common) and oracle EC2 instances
- name: Start amazon-cloudwatch-agent service
  ansible.builtin.shell: |
    /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:"{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_config_file }}"

# additional settings for EC2 instances if they exist
- name: Append settings for amazon-cloudwatch-agent for other EC2 instances
  ansible.builtin.shell: |
    /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -s -c file:"{{ amazon_cloudwatch_agent_config_path }}/{{ item }}.json"
  loop: "{{ cloudwatch_agent_configs|replace('-', '_') }}"
  loop_control:
    label: item
  when: cloudwatch_agent_configs is defined # currently none defined

# FIXME: maybe run a loop on 'append' so it pulls in anything that's in this particular directory? OR has a particular prefix?