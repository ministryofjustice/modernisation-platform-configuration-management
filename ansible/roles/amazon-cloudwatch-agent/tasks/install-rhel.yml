---
- name: Install amazon-cloudwatch-agent
  ansible.builtin.yum:
    name: "https://s3.eu-west-2.amazonaws.com/amazoncloudwatch-agent-eu-west-2/redhat/amd64/latest/amazon-cloudwatch-agent.rpm"

- name: Create amazon-cloudwatch-agent config directory
  ansible.builtin.file:
    path: /opt/aws/amazon-cloudwatch-agent/etc
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Create amazon-cloudwatch-agent config file
  ansible.builtin.template:
    src: amazon-cloudwatch-agent-linux-config.json.j2
    dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
    owner: root
    group: root
    mode: 0644

# - name: Start amazon-cloudwatch-agent service
#   ansible.builtin.shell:
#     cmd: sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

# No point enabling as there is nothing configured yet
#- name: Enable amazon-cloudwatch-agent service
#  service:
#    name: amazon-cloudwatch-agent
#    enabled: yes
