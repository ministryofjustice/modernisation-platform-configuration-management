---
  # by default all msi installs run with /log, /qn, /norestart arguments already
- name: Install amazon-cloudwatch-agent
  ansible.windows.win_package:
    path: https://s3.amazonaws.com/amazoncloudwatch-agent/windows/amd64/latest/amazon-cloudwatch-agent.msi
    state: present
 
- name: Create amazon-cloudwatch-agent config directory
  ansible.windows.win_file:
    path: C:\ProgramData\Amazon\AmazonCloudWatchAgent\Configs
    state: directory

- name: Create amazon-cloudwatch-agent config file
  ansible.windows.win_template:
    src: amazon-cloudwatch-agent-windows-config.json.j2
    dest: C:\ProgramData\Amazon\AmazonCloudWatchAgent\Configs\file_config.json

- name: Start amazon-cloudwatch-agent service
  ansible.windows.win_shell: C:\Program Files\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent-ctl.ps1 -a fetch-config -m ec2 -s -c file:"C:\ProgramData\Amazon\AmazonCloudWatchAgent\Configs\file_config.json"
