---
# FIXME: this check might or might not be needed elsewhere
# Some configs rely on whether collectd is installed or not
# - name: Check if collectd has been installed
#   ansible.builtin.shell: |
#     check_installed() {
#       check="$(rpm -qa | grep collectd)"
#       if [[ $check ]]
#       then 
#         return 0
#       else 
#         return 1
#       fi
#     }
#     check_installed
#   ignore_errors: true
#   register: collectd_installed

- name: Create amazon-cloudwatch-agent config directory
  ansible.builtin.file:
    path: "{{ amazon_cloudwatch_agent_config_path }}"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Get tag values for use in config file
  set_fact:
    name: "{{ ec2.tags.Name }}"
    server_type: "{{ ec2.tags['server-type'] }}"
    instance_id: "{{ ansible_ec2_instance_id }}"

# default cloudwatch-agent config file based on OS type (linux or windows)
# NOTE: windows default config doesn't exist yet
- name: Create OS specific amazon-cloudwatch-agent config file
  ansible.builtin.template:
    src: "{{ ansible_system|lower }}.json.j2"
    dest: "{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_config_file }}"
    owner: root
    group: root
    mode: 0755

# FIXME: this needs to exist elsewhere as part of setting up collectd
# - name: Create amazon-cloudwatch-agent config file for collectd
#   ansible.builtin.template:
#     src: agent_config_collectd.json.j2
#     dest: "{{ amazon_cloudwatch_agent_config_path }}/{{ amazon_cloudwatch_agent_collectd_config_file }}"
#     owner: root
#     group: root
#     mode: 0755
#   when: collectd_installed.rc == 0

# additional settings for EC2 instances if they exist
- name: template config files
  ansible.builtin.template:
    src: "{{ item|replace('-', '_') }}.json.j2"
    dest: "{{ amazon_cloudwatch_agent_config_path }}/{{ item|replace('-', '_') }}.json"
    owner: root
    group: root
    mode: 0755
  loop: "{{ cloudwatch_agent_configs }}"
  loop_control:
    label: item
  when: cloudwatch_agent_configs is defined # currently none defined


