---
- name: is collectd installed
  ansible.builtin.command: yum list | grep collectd
  register: collectd_installed
  check_mode: no
  changed_when: false
  ignore_errors: true

- name: Ensure the EPEL repository is available on Rhel 7
  block:
    - name: Ensure the EPEL repository is available
      ansible.builtin.package:
        name: epel-release
        state: installed
      register: epel_release_installed
      ignore_errors: true

    - name: Add epel-release to repolist
      ansible.builtin.shell: |
        yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
      when: epel_release_installed is failed
      ignore_errors: true

    - name: install collectd from epel-release
      ansible.builtin.package:
        name: collectd
        state: installed

  when: (ansible_distribution_major_version == '7') and (collectd_installed != 0)

- name: Ensure the EPEL repository is available on Rhel 6
  block:
    - name: Ensure the EPEL repository is available on Rhel 6
      ansible.builtin.package:
        name: epel-release
        state: installed
      register: epel_release_installed
      ignore_errors: true

    - name: Add epel-release to repolist on Rhel 6
      ansible.builtin.shell: |
        wget https://dl.fedoraproject.org/pub/archive/epel/6/x86_64/epel-release-6-8.noarch.rpm
        yum install -y epel-release-6-8.noarch.rpm
      when: epel_release_installed is failed

    # using shell as yum module doesn't run on Rhel6 due to old python version
    - name: Install collectd agent
      ansible.builtin.shell: |
        yum install -y collectd

  when: (ansible_distribution_major_version == '6') and (collectd_installed != 0)

- name: Ensure the EPEL repository is available on Rhel 8.7
  block:
    - name: Ensure the EPEL repository is available on Rhel 8.7
      ansible.builtin.package:
        name: epel-release
        state: installed
      register: epel_release_installed
      ignore_errors: true

    - name: Add epel-release to repolist on Rhel 8.7
      ansible.builtin.shell: |
        wget https://dl.fedoraproject.org/pub/archive/epel/8.5/Everything/x86_64/Packages/e/epel-release-8-15.el8.noarch.rpm
        yum install -y epel-release-8-15.el8.noarch.rpm
      when: epel_release_installed is failed

    # using shell as yum module doesn't run on Rhel6 due to old python version
    - name: Install collectd agent
      ansible.builtin.shell: |
        yum install -y collectd

  when: (ansible_distribution_version == '8.7') and (collectd_installed != 0)

- name: Configure collectd
  ansible.builtin.template:
    src: collectd.conf.j2
    dest: "/etc/collectd.conf"
    owner: root
    mode: 0644

- name: add linux conf for collectd to get service state as metrics
  ansible.builtin.copy:
    src: linux.conf
    dest: "/etc/collectd.d/linux.conf"
    owner: root
    mode: 0644

- name: create folder for exec script to collect metrics
  ansible.builtin.file:
    path: "/opt/collectd"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: add custom types file for bool types for collectd metrics
  ansible.builtin.copy:
    src: types.db.custom
    dest: /usr/share/collectd/types.db.custom
    owner: root
    mode: 0644

- name: Add linux service metrics script
  ansible.builtin.template:
    src: linux_service_metrics.sh.j2
    dest: /opt/collectd/linux_service_metrics.sh
    mode: 0755
    owner: root
  notify: restart collectd # pick up health check script config changes

- name: set up collectd for monitoring on nomis-db instances
  block:
    - name: Get oracle database sids for monitoring as a list from the oracle-sids tag
      set_fact:
        oracle_sid_list: '{{ ec2.tags["oracle-sids"].split() | default([]) | join(" ") }}'

    - name: add oracle conf for collectd to get service state as metrics
      ansible.builtin.copy:
        src: oracle.conf
        dest: "/etc/collectd.d/oracle.conf"
        owner: root
        mode: 0644

    - name: Add oracle_health check script
      ansible.builtin.template:
        src: oracle_health_metrics.sh.j2
        dest: /opt/collectd/oracle_health_metrics.sh
        mode: 0755
        owner: oracle
      notify: restart collectd # pick up health check script config changes

  when: ec2.tags['oracle-sids'] is defined

- name: set up collectd for monitoring on nomis-web instances
  block:
    - name: add weblogic conf for collectd to get service state as metrics
      ansible.builtin.copy:
        src: weblogic.conf
        dest: "/etc/collectd.d/weblogic.conf"
        mode: 0755

    - name: Add weblogic_health check script
      ansible.builtin.template:
        src: weblogic_service_metrics.sh.j2
        dest: /opt/collectd/weblogic_service_metrics.sh
        mode: 0755
      notify: restart collectd # pick up health check script config changes

  when: ansible_distribution_major_version == '6'

- name: Start collectd service
  ansible.builtin.service:
    name: collectd
    state: started
    enabled: yes
