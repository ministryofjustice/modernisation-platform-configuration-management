#!/bin/bash
# GoldenGate Master Control Script
# Generated by Ansible
# Usage: ogg_control.sh {start|stop|status|restart} {all|auditdata|auditref|mis} {extract|replicat|both}

GGHOME={{ oracle_goldengate_home }}
SCRIPTS_DIR={{ oracle_goldengate_scripts_dir }}

# Process names
EXTRACT_AUDITDATA={{ oracle_goldengate_streams.auditdata.extract_name }}
REPLICAT_AUDITDATA={{ oracle_goldengate_streams.auditdata.replicat_name }}
TNS_AUDITDATA={{ oracle_goldengate_streams.auditdata.tns_alias }}
EXTRACT_AUDITREF={{ oracle_goldengate_streams.auditref.extract_name }}
REPLICAT_AUDITREF={{ oracle_goldengate_streams.auditref.replicat_name }}
TNS_AUDITREF={{ oracle_goldengate_streams.auditref.tns_alias }}
EXTRACT_MIS={{ oracle_goldengate_streams.mis.extract_name }}
REPLICAT_MIS={{ oracle_goldengate_streams.mis.replicat_name }}
TNS_MIS={{ oracle_goldengate_streams.mis.tns_alias }}

ACTION=$1
STREAM=$2
PROCESS_TYPE=${3:-both}

usage() {
    echo "Usage: $0 {start|stop|status|restart} {all|auditdata|auditref|mis} {extract|replicat|both}"
    echo ""
    echo "Examples:"
    echo "  $0 start auditdata both      - Start both extract and replicat for auditdata"
    echo "  $0 stop auditref extract     - Stop only extract for auditref"
    echo "  $0 status all                - Show status of all processes"
    echo "  $0 restart mis replicat      - Restart only replicat for mis"
    exit 1
}

show_status() {
    local stream=$1
    local type=$2
    
    case "${stream}_${type}" in
        auditdata_extract)
            CMD=${EXTRACT_AUDITDATA}
            ;;
        auditdata_replicat)
            CMD=${REPLICAT_AUDITDATA}
            ;;
        auditref_extract)
            CMD=${EXTRACT_AUDITREF}
            ;;
        auditref_replicat)
            CMD=${REPLICAT_AUDITREF}
            ;;
        mis_extract)
            CMD=${EXTRACT_MIS}
            ;;
        mis_replicat)
            CMD=${REPLICAT_MIS}
            ;;
        *_both)
            CMD="ALL"
            ;;
    esac
    if [ "$stream" == "ALL" ]; then
        # get one ORACLE_SID from the running processes
        export ORACLE_SID=$(ps -ef | grep -E '[o]ra_pmon_' | awk '{print $NF}' | sed 's/ora_pmon_//' | head -n 1)
    else
        case "$stream" in
            auditdata)
                export ORACLE_SID=$TNS_AUDITDATA
                ;;
            auditref)
                export ORACLE_SID=$TNS_AUDITREF
                ;;
            mis)
                export ORACLE_SID=$TNS_MIS
                ;;
            *)
                echo "Unknown stream: $stream"
                return 1
                ;;
        esac
    fi
    export ORAENV_ASK=NO
    . oraenv > /dev/null 2>&1
    cd ${GGHOME}
    echo ""
    echo "=== Status for ${stream} ==="
    ./ggsci << EOF
INFO ${CMD}
EXIT
EOF
}

start_process() {
    local stream=$1
    local type=$2
    
    case "${stream}_${type}" in
        auditdata_extract)
            ${SCRIPTS_DIR}/start_extract_auditdata.sh
            ;;
        auditdata_replicat)
            ${SCRIPTS_DIR}/start_replicat_auditdata.sh
            ;;
        auditref_extract)
            ${SCRIPTS_DIR}/start_extract_auditref.sh
            ;;
        auditref_replicat)
            ${SCRIPTS_DIR}/start_replicat_auditref.sh
            ;;
        mis_extract)
            ${SCRIPTS_DIR}/start_extract_mis.sh
            ;;
        mis_replicat)
            ${SCRIPTS_DIR}/start_replicat_mis.sh
            ;;
        *)
            echo "Unknown stream/type combination: ${stream}/${type}"
            return 1
            ;;
    esac
}

stop_process() {
    local stream=$1
    local type=$2
    
    case "${stream}_${type}" in
        auditdata_extract)
            ${SCRIPTS_DIR}/stop_extract_auditdata.sh
            ;;
        auditdata_replicat)
            ${SCRIPTS_DIR}/stop_replicat_auditdata.sh
            ;;
        auditref_extract)
            ${SCRIPTS_DIR}/stop_extract_auditref.sh
            ;;
        auditref_replicat)
            ${SCRIPTS_DIR}/stop_replicat_auditref.sh
            ;;
        mis_extract)
            ${SCRIPTS_DIR}/stop_extract_mis.sh
            ;;
        mis_replicat)
            ${SCRIPTS_DIR}/stop_replicat_mis.sh
            ;;
        *)
            echo "Unknown stream/type combination: ${stream}/${type}"
            return 1
            ;;
    esac
}

# Validate arguments
if [ -z "$ACTION" ] || [ -z "$STREAM" ]; then
    usage
fi

# Execute action
case "$ACTION" in
    status)
        if [ "$STREAM" == "all" ]; then
            show_status "ALL"
        else
            show_status "$STREAM"
        fi
        ;;
        
    start)
        if [ "$STREAM" == "all" ]; then
            STREAMS="auditdata auditref mis"
        else
            STREAMS="$STREAM"
        fi
        
        for s in $STREAMS; do
            if [ "$PROCESS_TYPE" == "both" ] || [ "$PROCESS_TYPE" == "extract" ]; then
                echo "Starting Extract for $s..."
                start_process $s extract
            fi
            if [ "$PROCESS_TYPE" == "both" ] || [ "$PROCESS_TYPE" == "replicat" ]; then
                echo "Starting Replicat for $s..."
                start_process $s replicat
            fi
        done
        ;;
        
    stop)
        if [ "$STREAM" == "all" ]; then
            STREAMS="auditdata auditref mis"
        else
            STREAMS="$STREAM"
        fi
        
        for s in $STREAMS; do
            if [ "$PROCESS_TYPE" == "both" ] || [ "$PROCESS_TYPE" == "replicat" ]; then
                echo "Stopping Replicat for $s..."
                stop_process $s replicat
            fi
            if [ "$PROCESS_TYPE" == "both" ] || [ "$PROCESS_TYPE" == "extract" ]; then
                echo "Stopping Extract for $s..."
                stop_process $s extract
            fi
        done
        ;;
        
    restart)
        $0 stop $STREAM $PROCESS_TYPE
        sleep 2
        $0 start $STREAM $PROCESS_TYPE
        ;;
        
    *)
        echo "Invalid action: $ACTION"
        usage
        ;;
esac

exit 0
