---
# designed to conform with https://dsdmoj.atlassian.net/wiki/spaces/DSTT/pages/579994207/UDEV+configuraion+for+ASM+Disks

- name: Create directory for scripts
  file:
    path: "{{ oracle_dynamic_disk_scripts_dir }}"
    state: directory
    owner: "{{ oracle_dynamic_disk_owner }}"
    group: "{{ oracle_dynamic_disk_group }}"
    mode: "0755"
    recurse: yes

- name: Create log dir
  file:
    path: "{{ oracle_dynamic_disk_log_dir }}"
    state: directory
    owner: "{{ oracle_dynamic_disk_owner }}"
    group: "{{ oracle_dynamic_disk_group }}"
    mode: "0644"
    recurse: yes

- name: Create oracle disk dir
  file:
    path: /dev/oracle
    state: directory
    owner: "{{ oracle_dynamic_disk_owner }}"
    group: "{{ oracle_dynamic_disk_dev_oracle_group }}"
    mode: "0755"

- name: Add script
  template:
    src: dynamic_disk_fix.sh.j2
    dest: "{{ oracle_dynamic_disk_fix_file }}"
    owner: "{{ oracle_dynamic_disk_owner }}"
    group: "{{ oracle_dynamic_disk_group }}"
    mode: "0700"
  register: dynamic_disk_fix_script

- name: Add has restart script
  template:
    src: oracle_has_restart.sh
    dest: "{{ oracle_dynamic_disk_has_restart_file }}"
    owner: "{{ oracle_dynamic_disk_owner }}"
    group: "{{ oracle_dynamic_disk_dev_oracle_group }}"
    mode: "0700"

- name: Add cron job to run fix at reboot
  template:
    src: oracle_dynamic_disk_fix.j2
    dest: /etc/cron.d/oracle_dynamic_disk_fix
    owner: root
    group: root
    mode: "0644"

- name: Add logrotate
  template:
    src: oracle_dynamic_disk_fix.logrotate.j2
    dest: /etc/logrotate.d/oracle_dynamic_disk_fix.logrotate
    owner: root
    group: root
    mode: "0644"

  # this is to generate the working save file created by the script
- name: run dynamic disk fix script
  command: "sudo {{ oracle_dynamic_disk_fix_file }}"
  when: dynamic_disk_fix_script.changed
