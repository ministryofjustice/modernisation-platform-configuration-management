---
- name: Verify recovery catalog usage defined for oracle database backup
  ansible.builtin.set_fact:
    recovery_catalog_defined_check: 1
  when: recovery_catalog is defined

- name: Set catalog parameters if recovery catalog defined
  ansible.builtin.set_fact:
    catalog_parameter: "-n Y -c RCVCAT"
  when: recovery_catalog_defined_check == 1 and recovery_catalog == 1

- name: Generate backup command parameters for scheduler
  ansible.builtin.set_fact:
    backup_command: "/home/oracle/admin/rman_scripts/{{ rman_backup_script }} -t HOT -f S3 {{ catalog_parameter }} -i "

- name: create script directory
  ansible.builtin.file:
    path: "{{ item }}"
    owner: oracle
    group: oinstall
    state: directory
    recurse: yes
  loop:
    - /home/oracle/admin/rman_scripts/logs
    - /home/oracle/admin/rman_scripts/status

- name: copy scripts
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/home/oracle/admin/rman_scripts/{{ item }}"
    owner: oracle
    group: oinstall
    mode: "0700"
  loop:
    - "{{ rman_backup_script }}"
    - "{{ rman_backup_monitoring_script }}"

- name: setup rman database backup level 0
  ansible.builtin.cron:
    name: "{{ item.name }}"
    weekday: "{{ item.weekday }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    user: root
    job: "su oracle -c '{{ backup_command }} 0' 2>&1 | logger -p local3.info -t rman-backup"
  loop: "{{ rman_backup_cron.backup_level_0 | list }}"

- name: setup rman database backup level 1
  ansible.builtin.cron:
    name: "{{ item.name }}"
    weekday: "{{ item.weekday }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    user: root
    job: "su oracle -c '{{ backup_command }} 1' 2>&1 | logger -p local3.info -t rman-backup"
  loop: "{{ rman_backup_cron.backup_level_1 | list }}"

- name: setup rman backup monitoring job
  ansible.builtin.cron:
    name: "{{ item.name }}"
    weekday: "{{ item.weekday }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    user: root
    job: "{{ item.job }}"
  loop: "{{ rman_backup_cron.monitoring | list }}"
