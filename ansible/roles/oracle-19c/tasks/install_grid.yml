---
- name: Check oracle 19c Grid Infrastructure installed
  ansible.builtin.stat:
    path: "{{ oracle_inventory }}/orainstRoot.sh"
  register: grid_software_installed

- name: Install oracle 19c Grid Infrastructure
  block:
    - name: Create response files
      template:
        src: "{{ item }}.j2"
        dest: "{{ stage }}/{{ item }}"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        mode: "0700"
      loop:
        - "{{ grid_response_file }}"
        - "{{ grid_install_script }}"

    - name: Unzip Oracle 19c Grid Infrastructure software
      become_user: "{{ oracle_install_user }}"
      ansible.builtin.unarchive:
        src: "{{ stage }}/{{ grid_software }}"
        dest: "{{ grid_home }}"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        remote_src: yes

    - name: Unzip grid psu patch software
      ansible.builtin.unarchive:
        src: "{{ stage }}/{{ psu_patch }}"
        dest: "{{ stage }}/psu"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        remote_src: yes

    - name: Upgrade OPatch in grid home
      ansible.builtin.unarchive:
        src: "{{ stage }}/{{ opatch }}"
        dest: "{{ grid_home }}"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        remote_src: yes

    - name: Run oracle grid install (synchronous)
      become_user: "{{ oracle_install_user }}"
      changed_when: "'Successfully Setup Software with warning(s).' not in grid_install_output.stdout"
      ansible.builtin.command:
        cmd: "{{ stage }}/{{ grid_install_script }}"
      register: grid_install_output

    - name: Run oracle grid install
      become_user: "{{ oracle_install_user }}"
      ansible.builtin.command:
        cmd: "{{ stage }}/{{ grid_install_script }}"
      register: grid_install_output
      async: 7200
      poll: 0
      vars:
        ansible_remote_tmp: /tmp/.ansible
        ansible_async_dir: /tmp/.ansible_async

    - name: Wait grid install to finish
      become_user: "{{ oracle_install_user }}"
      async_status:
        jid: "{{ grid_install_output.ansible_job_id }}"
      changed_when: "'Successfully Setup Software with warning(s).' not in grid_install_output.stdout"
      register: result
      until: result.finished
      retries: 240
      delay: 30
      vars:
        ansible_remote_tmp: /tmp/.ansible
        ansible_async_dir: /tmp/.ansible_async

    - name: Run orainstRoot script
      ansible.builtin.command: "{{ oracle_inventory }}/orainstRoot.sh"
      become_user: root

    - name: Run root script
      ansible.builtin.command: "{{ grid_home }}/root.sh"
      become_user: root

    - name: Run configuration script
      ansible.builtin.command:
        cmd: "{{ grid_home }}/gridSetup.sh -executeConfigTools -responseFile {{ stage }}/{{ grid_response_file }} -silent"
      become_user: "{{ oracle_install_user }}"

  # block
  when: not grid_software_installed.stat.exists
