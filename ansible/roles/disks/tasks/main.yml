---
- import_tasks: get-ebs-to-linux-device-map.yml
  tags:
    - always

- import_tasks: wait-for-volumes.yml
  tags:
    - amibuild
    - ec2provision
    - disks_wait_for_volumes

- include_tasks:
    file: partition-disk-rhel.yml
    apply:
      tags:
        - amibuild
        - ec2provision
        - disks_partition
  tags:
    - amibuild
    - ec2provision
    - disks_partition
  loop_control:
    loop_var: disk_partition
  loop: "{{ disks_partition }}"
  when: ansible_distribution == 'RedHat' and disks_partition is defined

- include_tasks:
    file: mount-disk-rhel.yml
    apply:
      tags:
        - amibuild
        - ec2provision
        - ec2patch
        - disks_mount
  tags:
    - amibuild
    - ec2provision
    - ec2patch
    - disks_mount
  loop_control:
    loop_var: disk_mount
  loop: "{{ disks_mount | selectattr('fstype', 'defined') }}"
  when: ansible_distribution == 'RedHat' and disks_mount is defined

# if UUID changes, might need to disable and enable swap
- include_tasks:
    file: disable-swap-rhel.yml
    apply:
      tags:
        - ec2provision
        - disks_disable_swap
      vars:
        swap_device_name: "{{ ebs_to_linux_device_map[item.ebs_device_name] }}"
  tags:
    - ec2provision
    - disks_disable_swap
  loop: "{{ disks_mount | selectattr('fstype', 'defined') | selectattr('fstype', 'equalto', 'swap') }}"
  when: ansible_distribution == 'RedHat' and disks_mount is defined

- include_tasks:
    file: enable-swap-rhel.yml
    apply:
      tags:
        - amibuild
        - ec2provision
        - ec2patch
        - disks_enable_swap
      vars:
        swap_device_name: "{{ ebs_to_linux_device_map[item.ebs_device_name] }}"
  tags:
    - amibuild
    - ec2provision
    - ec2patch
    - disks_enable_swap
  loop: "{{ disks_mount | selectattr('fstype', 'defined') | selectattr('fstype', 'equalto', 'swap') }}"
  when: ansible_distribution == 'RedHat' and disks_mount is defined
