---
- name: OEM 13.5 agent Discover and promote targets from host
  block:
    - name: Create directories
      ansible.builtin.file:
        path: "{{ stage }}/emcli/conf"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        state: directory
        recurse: yes

    - name: Get emcli from OMS server
      ansible.builtin.shell: |
        set -eo pipefail
        main() {
          cd {{ stage }}/emcli
          wget -P /u02/stage/emcli --quiet --no-check-certificate https://{{ OMS_SERVER }}:7803/em/public_lib_download/emcli/kit/emclikit.jar
        }
        main 2>&1 | logger -p local3.info -t ansible-oracle-oem-emclikit-get

    - name: Install emcli
      ansible.builtin.shell: |
        set -eo pipefail
        main() {
          export JAVA_HOME={{ oem_agent_base }}/agent_{{ OEM_AGENT_VERSION }}/oracle_common/jdk/jre
          ${JAVA_HOME}/bin/java -jar {{ stage }}/emcli/emclikit.jar -install_dir={{ stage }}/emcli
        }
        main 2>&1 | logger -p local3.info -t ansible-oracle-oem-emcli-install

    - name: Copy add targets shell script template
      template:
        src: "add_targets.sh.j2"
        dest: "{{ stage }}/add_targets.sh"
        mode: u=rwx,g=r,o=r

    - name: Setup emcli, discover and promote targets
      ansible.builtin.shell: |
        set -eo pipefail
        . ~/.bash_profile
        main() {
          export JAVA_HOME={{ oem_agent_base }}/agent_{{ OEM_AGENT_VERSION }}/oracle_common/jdk/jre
          echo "emcli setup"
          OEM_SYSMAN_PASSWORD=$(aws secretsmanager get-secret-value --secret-id "arn:aws:secretsmanager:{{ region }}:{{ account_ids[oem_secretsmanager_passwords.oem.account_name] }}:secret:{{ oem_secretsmanager_passwords.emrep.secret }}" --query "SecretString" | jq -r 'fromjson | .sysman')
          echo ${OEM_SYSMAN_PASSWORD} | {{ stage }}/emcli/emcli setup -url=https://{{ OMS_SERVER }}:7803/em -username="sysman" -dir="{{ stage }}/emcli/conf" -trustall -noregister 
          # Now we must unset the role which we used to access OEM Secrets, so we can access local account secrets instead
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
          {{ stage }}/add_targets.sh
        }
        main 2>&1 | logger -p local3.info -t ansible-oracle-oem-emcli-install
      async: 86400
      poll: 60
      environment: 
        AWS_ACCESS_KEY_ID: "{{ em_secrets_role.sts_creds.access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ em_secrets_role.sts_creds.secret_key }}"
        AWS_SESSION_TOKEN: "{{ em_secrets_role.sts_creds.session_token }}"

  # block
  become: true
  become_user: oracle
