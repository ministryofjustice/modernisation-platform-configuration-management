---
- name: Get SSM parameters
  import_role:
    name: ssm-passwords
  vars:
    ssm_passwords: "{{ oem_ssm_passwords }}"

- name: Get OEM secrets
  import_role:
    name: secretsmanager-passwords
  vars:
    secretsmanager_passwords: "{{ oem_secretsmanager_passwords }}"

- name: Set password facts
  set_fact:
    oem_sysman_password: "{{ secretsmanager_passwords_dict['emrep_passwords'].passwords['sysman'] }}"
    oem_agent_password: "{{ secretsmanager_passwords_dict['oem_passwords'].passwords['agentreg'] }}"
    asmsnmp_password: "{{ ssm_passwords_dict['asm_passwords'].passwords['ASMSNMP'] }}"

- name: Get private ip address of the ec2 instance
  set_fact:
    server_private_ip_address: "{{ ec2.private_ip_address }}"

- name: Check parameters
  set_fact:
    db_all_variables_set: true
  when:
    - oem_sysman_password|length > 0
    - oem_agent_password|length > 0
    - asmsnmp_password|length > 0

- name: Fail if missing parameters
  fail:
    msg: Ensure all required parameters are set
  when: not db_all_variables_set|default(false)
