# DO NOT READ PASSWORDS INTO ANSIBLE AS THESE MAY BE LEAKED ONTO THE COMMAND LINE

# ---
# - name: Get OEM secrets
#   import_role:
#     name: secretsmanager-passwords
#   vars:
#     secretsmanager_passwords: "{{ oem_secretsmanager_passwords }}"

# - name: Set password facts
#   set_fact:
#     oem_sysman_password: "{{ secretsmanager_passwords_dict['emrep'].passwords['sysman'] }}"
#     oem_agent_password: "{{ secretsmanager_passwords_dict['oem'].passwords['agentreg'] }}"
#     asmsnmp_password: "{{ secretsmanager_passwords_dict['asm'].passwords['ASMSNMP'] }}"

# - name: Get private ip address of the ec2 instance
#   set_fact:
#     server_private_ip_address: "{{ ec2.private_ip_address }}"

# - name: Check parameters
#   set_fact:
#     db_all_variables_set: true
#   when:
#     - oem_sysman_password|length > 0
#     - oem_agent_password|length > 0
#     - asmsnmp_password|length > 0

# - name: Fail if missing parameters
#   fail:
#     msg: Ensure all required parameters are set
#   when: not db_all_variables_set|default(false)

- name: Get the current caller identity information
  amazon.aws.aws_caller_info:
  register: caller_info
  run_once: true

- name: Assume Role which has Access to EM Secrets
  community.aws.sts_assume_role:
    role_arn: "arn:aws:iam::{{ caller_info.account }}:role/EC2OracleEnterpriseManagementSecretsRole"
    role_session_name: "EC2OracleEnterpriseManagementSecretsRoleSession"
  register: em_secrets_role
  run_once: true