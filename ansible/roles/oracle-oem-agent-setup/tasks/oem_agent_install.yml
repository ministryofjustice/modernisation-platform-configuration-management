---
- name: Install oracle agent prerequisite zip package
  ansible.builtin.yum:
    name: zip
    state: present
    disable_gpg_check: true

- name: Create directories
  ansible.builtin.file:
    path: "{{ stage }}"
    owner: "{{ oracle_install_user }}"
    group: "{{ oracle_install_group }}"
    state: directory
    recurse: yes

- name: Install OEM 13.5 agent and add targets
  block:
    - name: Get AgentPull.sh script from OMS server
      ansible.builtin.shell: |
        set -eo pipefail
        main() {
          cd {{ stage }}
          curl "https://{{ OMS_SERVER }}:7803/em/install/getAgentImage" --insecure -o AgentPull.sh
        }
        main 2>&1 | logger -p local3.info -t ansible-oracle-oem-agentpull-get

    - name: Update AgentPull.sh file to change omsHost
      ansible.builtin.lineinfile:
        path: "{{ stage }}/AgentPull.sh"
        regexp: "^omsHost="
        line: "omsHost={{ OMS_SERVER }}"

    - name: Update AgentPull.sh permissions to execute
      ansible.builtin.file:
        path: "{{ stage }}/AgentPull.sh"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        mode: "0700"

    - name: Copy Response File to Install OEM Agent
      ansible.builtin.template:
        src: agent_install.j2
        dest: "{{ agent_install_response_file }}"
        mode: "0600"

    # We can either use the default Agent image that comes with OEM or a Gold Image
    # that we have created for the environment.  We prefer to use the Gold Image if
    # it exists, so check for availability.
    - name: Show Gold Images Available on OEM
      ansible.builtin.shell: |
          {{ stage }}/AgentPull.sh -showGoldImages
      register: show_gold_images
      changed_when: false

    - name: Check if Requested Gold Image is Available
      set_fact:
         gold_image_available:  "{{ agent_image_name in show_gold_images.stdout_lines }}"

    # Although in principle AgentPull.sh should be able to install the Gold Image, in
    # practice it hits a bug whereby it is not installed as a subscribed agent (and
    # cannot be subscribed manually either).  So, although the agent does get installed
    # it cannot be automatically upgraded through OEM.  Therefore, instead, we download
    # the agent image as a zip file and run agentDeploy.sh (this will successfully
    # subscribe the agent).
    - name: Install Gold Image
      when: gold_image_available
      block:

          - name: Add Gold Image Name to Response File
            ansible.builtin.lineinfile:
              path: "{{ stage }}/AgentPull.sh"
              line: "IMAGE_NAME={{ agent_image_name }}"
              insertafter: EOF

          - name: Create Temporary Directory for Downloading Gold Image
            ansible.builtin.tempfile:
               state: directory
               suffix: agent_gold_image
            register: gold_image_tmp

          # If AGENT_BASE_DIR is set the Gold Image will be placed there,
          # but we want to just place it in a temporary location so we remove
          # that parameter
          - name: Remove AGENT_BASE_DIR from Response File
            ansible.builtin.lineinfile:
                path: "{{ agent_install_response_file }}"
                state: absent    
                regexp: '^\s*AGENT_BASE_DIR\s*=.*$'

          - name: Download OEM agent Gold Image
            ansible.builtin.shell: |
              set -eo pipefail
              main() {
                cd {{ gold_image_tmp.path }}
                {{ stage }}/AgentPull.sh RSPFILE_LOC={{ agent_install_response_file }} -download_only
              }
              main 2>&1 | logger -p local3.info -t ansible-oracle-download-gold-image

          - name: Unzip the Image
            ansible.builtin.unarchive:
               src: "{{ gold_image_tmp.path }}/agent.zip"
               dest: "{{ gold_image_tmp.path }}"
               remote_src: true

          - name: Copy Response File to Deploy OEM Agent
            ansible.builtin.template:
              src: agent_deploy.j2
              dest: "{{ agent_deploy_response_file }}"
              mode: "0600"

          - name: Deploy OEM agent from Gold Image
            ansible.builtin.shell: |
              set -eo pipefail
              main() {
                cd {{ gold_image_tmp.path }}
                ./agentDeploy.sh RESPONSE_FILE={{ agent_deploy_response_file }}
              }
              main 2>&1 | logger -p local3.info -t ansible-oracle-oem-agent-deploy
            async: 86400
            poll: 60
            throttle: 1

    # If no Gold Image exists then we just use the default image that ships with OEM
    - name: Install Default Image
      when: not gold_image_available
      block:

        # Running multiple AgentPull.sh scripts simultaneously on different
        # instances has been found to sometimes result in corruption of
        # downloaded zip files.  It is unclear why this is happening (possible
        # concurrency or overloading on OMS, or session management issues).
        # To avoid the problem we throttle this task to happen only on one
        # host at a time.
        # NB: If we are installing the default Agent on a host with no databases
        #     it will only install the DB Discovery Plugin; not the DB Plugin
        #     This can be installed later using:
        #        emcli deploy_plugin_on_agent -agent_names="<agent>:3872" -plugin=oracle.sysman.db
        - name: Install OEM agent
          ansible.builtin.shell: |
            set -eo pipefail
            main() {
              {{ stage }}/AgentPull.sh RSPFILE_LOC={{ agent_install_response_file }}
            }
            main 2>&1 | logger -p local3.info -t ansible-oracle-oem-agent-install
          async: 86400
          poll: 60
          throttle: 1

  always:
    - name: Remove Response Files
      file:
        path: "{{ response_file }}"
        state: absent
      loop_control:
        loop_var: response_file
      loop:
         - "{{ agent_install_response_file }}"
         - "{{ agent_deploy_response_file }}"

  # block
  become: true
  become_user: oracle

- name: Post-Install OEM 13.5 agent Root Actions
  block:
    - name: Execute root.sh
      ansible.builtin.shell: |
        set -eo pipefail
        main() {
          {{ agent_home }}/root.sh
        }
        main 2>&1 | logger -p local3.info -t ansible-oracle-oem-root-script

    - name: Copy Script to fix SELinux File Labels on Agent Startup Script
      ansible.builtin.copy:
        src: selinux_label_gcstartup.sh
        dest: "{{ stage }}/selinux_label_gcstartup.sh"
        owner: root
        group: root
        mode: "0700"

    - name: Fix SELinux File Labels on Agent Startup Script
      ansible.builtin.shell: |
        set -eo pipefail
        main() {
          {{ stage }}/selinux_label_gcstartup.sh
        }
        main 2>&1 | logger -p local3.info -t ansible-oracle-oem-selinux-label-gcstartup-script
      register: run_selinux_label_gcstartup
      changed_when: run_selinux_label_gcstartup.stdout is search('.*changed.*')

  always:
    # Presense of the SELinux fix script may prevent agent patching, so ensure it is removed
    - name: Remove SELinux Fix Script from Staging Directory
      file:
        path: "{{ stage }}/selinux_label_gcstartup.sh"
        state: absent

  # block
  become: true
  become_user: root

- name: OEM 13.5 emcli setup
  block:
    - name: Create directories
      ansible.builtin.file:
        path: "{{ app_dir }}/emcli/conf"
        owner: "{{ oracle_install_user }}"
        group: "{{ oracle_install_group }}"
        state: directory
        recurse: yes

    - name: Remove previous download of emcli to allow download
      file:
        path: "{{ app_dir }}/emcli/emclikit.jar"
        state: absent

    - name: Get emcli from OMS server
      ansible.builtin.shell: |
        cd {{ app_dir }}/emcli
        wget -P {{ app_dir }}/emcli --no-check-certificate https://{{ OMS_SERVER }}:7803/em/public_lib_download/emcli/kit/emclikit.jar

    - name: Install emcli
      ansible.builtin.shell: |
        export JAVA_HOME={{ agent_home }}/oracle_common/jdk/jre
        ${JAVA_HOME}/bin/java -jar {{ app_dir }}/emcli/emclikit.jar -install_dir={{ app_dir }}/emcli

    - name: EMCLI setup with password cleanup
      block:
        - name: Write SYSMAN password to a hidden temp file
          copy:
            content: "{{ oem_sysman_password }}"
            dest: "/tmp/.emcli_password"
            mode: "0600"
          no_log: true

        - name: Setup EMCLI
          ansible.builtin.shell: |
            . ~/.bash_profile
            export JAVA_HOME={{ agent_home }}/oracle_common/jdk/jre
            SYSMAN_PASSWORD=$(< /tmp/.emcli_password)
            rm -f /tmp/.emcli_password
            echo "${SYSMAN_PASSWORD}" | {{ app_dir }}/emcli/emcli setup -url=https://{{ OMS_SERVER }}:7803/em -username="sysman" -dir="{{ app_dir }}/emcli/conf" -trustall -noregister
            unset SYSMAN_PASSWORD
          register: emcli_setup_result
          failed_when: emcli_setup_result.rc != 0

      always:
        - name: Ensure temp password file is deleted (cleanup)
          file:
            path: /tmp/.emcli_password
            state: absent
          ignore_errors: true

  # block
  become: true
  become_user: oracle
