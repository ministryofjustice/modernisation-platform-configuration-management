#!/bin/bash

export PATH=/usr/local/bin:${PATH}
EMCLI_DIR={{ app_dir }}/emcli
HOSTNAME=`hostname`
HOST_FQDN_NAME=$(hostname --fqdn)
[[ `hostname` = t* ]] && LIFECYCLE_STATUS="Test" || LIFECYCLE_STATUS="Production"

# For delius hosts, we cannot use the hostname to determine the lifecycle status, so we use the tags instead
if [[ "{{ ec2.tags['application'] }}" == "delius" ]]; then
   LIFECYCLE_STATUS=$(echo {{ ec2.tags['environment-name'].split('-')[-1] }})
   # First character must be made uppercase
   LIFECYCLE_STATUS="${LIFECYCLE_STATUS^}"
   # Oracle does not support a Preproduction status so use Staging instead
   [[ "$LIFECYCLE_STATUS" == "Preproduction" ]] && LIFECYCLE_STATUS="Staging"
 fi

INVENTORY_LOC=/u01/app/oraInventory
cd ${EMCLI_DIR}
if [ `grep "^+ASM" /etc/oratab | awk -F: '{ print $2 }'| wc -l` -eq 1 ]
then
        echo "emcli add target Grid Infrastructure home"
        GRID_HOME_NAME=`grep grid  ${INVENTORY_LOC}/ContentsXML/inventory.xml | awk -F\" '{ print $2 }'`
        GRID_HOME=`grep grid ${INVENTORY_LOC}/ContentsXML/inventory.xml | awk -F\" '{ print $4 }'`
        ./emcli add_target -name="${GRID_HOME_NAME}_${HOST_FQDN_NAME}" -type="oracle_home" -host="${HOST_FQDN_NAME}" -properties="HOME_TYPE:O;INSTALL_LOCATION:${GRID_HOME};INVENTORY:${INVENTORY_LOC};orcl_gtp_lifecycle_status:${LIFECYCLE_STATUS};orcl_gtp_line_of_bus:{{ ec2.tags['application'] }};"
        echo "emcli add HAS target"
        ./emcli add_target -name="has_${HOST_FQDN_NAME}" -type="has" -host="${HOST_FQDN_NAME}" -properties="OracleHome:${GRID_HOME};orcl_gtp_lifecycle_status:${LIFECYCLE_STATUS};orcl_gtp_line_of_bus:{{ ec2.tags['application'] }};"
        echo "emcli add ASM target"
        # Search needs to use case sensitive keys so we convert all to lowercase (as different apps use different case)
        ASMSNMPPASSWORD=$(aws secretsmanager get-secret-value --secret-id "{{ asm_monitoring_secret_name }}" --query SecretString --output text | jq -r .{{ asm_monitoring_secret_username }})
        ./emcli add_target -name="+ASM_${HOST_FQDN_NAME}" -type="osm_instance" -host="${HOST_FQDN_NAME}" -credentials="UserName:{{ asm_monitoring_secret_username|lower }};password:${ASMSNMPPASSWORD};Role:sysdba" -properties="SID:+ASM;Port:1521;OracleHome:${GRID_HOME};MachineName:${HOST_FQDN_NAME};orcl_gtp_lifecycle_status:${LIFECYCLE_STATUS};orcl_gtp_line_of_bus:{{ ec2.tags['application'] }};"
        echo "emcli add Listener"
        ./emcli add_target -name="LISTENER_${HOST_FQDN_NAME}" -type="oracle_listener" -host="${HOST_FQDN_NAME}" -properties="LsnrName:LISTENER;ListenerOraDir:${GRID_HOME}/network/admin;Port:1521;OracleHome:${GRID_HOME};Machine:${HOST_FQDN_NAME};orcl_gtp_lifecycle_status:${LIFECYCLE_STATUS};orcl_gtp_line_of_bus:{{ ec2.tags['application'] }};"
fi

if [ `grep "db"  /etc/oratab | awk -F: '{ print $2 }'| wc -l` -eq 1 ]
then
        echo "emcli add target database homes"
        DB_HOME_NAME=`grep db ${INVENTORY_LOC}/ContentsXML/inventory.xml | awk -F\" '{ print $2 }'`
        DB_HOME=`grep ${i} ${INVENTORY_LOC}/ContentsXML/inventory.xml | awk -F\" '{ print $4 }'`
        ./emcli add_target -name="${DB_HOME_NAME}_${HOST_FQDN_NAME}" -type="oracle_home" -host="${HOST_FQDN_NAME}" -properties="HOME_TYPE:O;INSTALL_LOCATION:${DB_HOME};INVENTORY:${INVENTORY_LOC};orcl_gtp_lifecycle_status:${LIFECYCLE_STATUS};orcl_gtp_line_of_bus:{{ ec2.tags['application'] }};"
fi

if [ `grep "db"  /etc/oratab | awk -F: '{ print $2 }'| wc -l` -gt 0 ]
then
        echo "emcli add target database homes"
        DB_HOME_NAME=`grep db ${INVENTORY_LOC}/ContentsXML/inventory.xml | awk -F\" '{ print $2 }'`
        DB_HOME=`grep db ${INVENTORY_LOC}/ContentsXML/inventory.xml | awk -F\" '{ print $4 }'`
        ./emcli add_target -name="${DB_HOME_NAME}_${HOST_FQDN_NAME}" -type="oracle_home" -host="${HOST_FQDN_NAME}" -properties="HOME_TYPE:O;INSTALL_LOCATION:${DB_HOME};INVENTORY:${INVENTORY_LOC};orcl_gtp_lifecycle_status:${LIFECYCLE_STATUS};orcl_gtp_line_of_bus:{{ ec2.tags['application'] }}"
        for i in `grep db  /etc/oratab| grep -v "^#" | awk -F: '{ print $1 }'`
        do
                echo ${i}
                DB_ROLE=$(srvctl config database -d ${i} | awk -F: '/Database role/{print $2}' | xargs)
                if [[ "$DB_ROLE" == "PRIMARY" ]]; then
                  MONITORING_USER={{ db_monitoring_secret_primary_username }}
                  MONITORING_ROLE={{ db_monitoring_secret_primary_role }}
                else
                  MONITORING_USER={{ db_monitoring_secret_standby_username }}
                  MONITORING_ROLE={{ db_monitoring_secret_standby_role }}
                fi
                SECRETNAME="{{ db_monitoring_secret_name }}"
                DBPASSWORD=$(aws secretsmanager get-secret-value --secret-id "${SECRETNAME/_DBNAME_/$i}" --query SecretString --output text | jq -r ".${MONITORING_USER}")
                ./emcli add_target -name="${i}" -type="oracle_database" -host="${HOST_FQDN_NAME}" -credentials="UserName:${MONITORING_USER};password:${DBPASSWORD};Role:${MONITORING_ROLE}" -properties="SID:${i};Port:1521;OracleHome:${DB_HOME};MachineName:${HOST_FQDN_NAME};orcl_gtp_lifecycle_status:${LIFECYCLE_STATUS};orcl_gtp_line_of_bus:{{ ec2.tags['application'] }};"
                # oracle_dbsys added  due to encountered bug     
                if [ `./emcli get_targets -targets=oracle_dbsys | grep ${i} | wc -l` -eq 0 ] 
                then 
	                ./emcli add_target -name="${i}_sys" -type="oracle_dbsys"
		        ./emcli create_assoc -assoc_type="relies_on_key_component" -source="${i}_sys:oracle_dbsys" -dest="${i}:oracle_database"
                fi
        done
fi

## Set Properties for pre-existing Internal targets (host and oracle_emd targets are created automatically when agent installed)
function set_internal_target_properties()
{
INTERNAL_TARGET_TYPE=$1
INTERNAL_TARGET=$({{ agent_home }}/bin/emctl config agent listtargets | grep ", ${INTERNAL_TARGET_TYPE}]" | cut -d, -f1 | sed 's/^\[//')
LIFECYCLE=$(./emcli list -resource=TargetProperties -search="TARGET_NAME='${INTERNAL_TARGET}'" -search="PROPERTY_NAME='orcl_gtp_lifecycle_status'" -columns="PROPERTY_VALUE" -script -noheader)
# We change the subseparator from colon as the agent (oracle_emd) target already contains a colon
[[ -z ${LIFECYCLE} ]] && ./emcli set_target_property_value -subseparator=property_records="@@" -property_records="${INTERNAL_TARGET}@@${INTERNAL_TARGET_TYPE}@@LifeCycle Status@@${LIFECYCLE_STATUS}"
LINE_OF_BUSINESS=$(./emcli list -resource=TargetProperties -search="TARGET_NAME='${INTERNAL_TARGET}'" -search="PROPERTY_NAME='orcl_gtp_line_of_bus'" -columns="PROPERTY_VALUE" -script -noheader)
[[ -z ${LINE_OF_BUSINESS} ]] && ./emcli set_target_property_value -subseparator=property_records="@@" -property_records="${INTERNAL_TARGET}@@${INTERNAL_TARGET_TYPE}@@Line of Business@@{{ ec2.tags['application'] }}"
}

set_internal_target_properties host
set_internal_target_properties oracle_emd
