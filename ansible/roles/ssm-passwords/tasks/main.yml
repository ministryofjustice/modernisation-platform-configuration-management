---
- name: Prepare ssm_passwords_dict fact
  set_fact:
    ssm_passwords_dict: "{{ ssm_passwords_dict|default({}) }}"

# install so scripts can easily access passwords
- name: Install jq
  ansible.builtin.yum:
    name: "jq"
    state: present

- name: Get SSM Parameters
  set_fact:
    ssm_passwords_dict: |
      {{ ssm_passwords_dict | combine({
           param.key: {
             'parameter': param.value.parameter,
             'value': lookup('amazon.aws.aws_ssm', param.value.parameter, region='eu-west-2')
           }
         }, recursive=true) }}
  loop_control:
    loop_var: param
    label: "{{ param.key }}"
  loop: "{{ ssm_passwords | dict2item }}"

# If this fails, the SSM parameter doesn't exist or isn't valid json
- name: Prepare any placeholder parameters
  set_fact:
    ssm_passwords_dict: |
      {{ ssm_passwords_dict | combine({
           param.key: {
             'passwords': {} if 'placeholder' in ssm_passwords_dict[param.key].value else ssm_passwords_dict[param.key].value|from_json
           }
         }, recursive=true) }}
  loop_control:
    loop_var: param
    label: "{{ param.key }}"
  loop: "{{ ssm_passwords | dict2item }}"

# The if statement:
# - use the password defined in the ssm_passwords variable if there is one
# - else use existing password defined in the SecretString and force_rotate not set
# - else generate random password if the value is set to auto in ssm_passwords
# - else fail
# Oracle passwords must start with letter and contain at least one digit
- name: Generate any missing passwords
  set_fact:
    ssm_passwords_dict: |
      {{ ssm_passwords_dict | combine({
           param[0].key: {
             'newpasswords': {
               param[1].keys()|first:
                 param[1].values()|first
                   if param[1].values()|first != None and param[1].values()|first != 'auto'
                 else ssm_passwords_dict[param[0].key].passwords[param[1].keys()|first]
                   if param[1].keys()|first in ssm_passwords_dict[param[0].key].passwords
                   and [param[0].key, param[1].keys()|first]|join(':') not in ssm_passwords_force_rotate
                 else lookup('ansible.builtin.password', '/dev/null chars=ascii_letters length=1')
                 + lookup('ansible.builtin.password', '/dev/null chars=digits length=1')
                 + lookup('ansible.builtin.password', '/dev/null chars=ascii_letters,digits length=13')
                   if param[1].values()|first == 'auto'
                 else None
             },
             'oldpasswords': {
               param[1].keys()|first:
                 ssm_passwords_dict[param[0].key].passwords[param[1].keys()|first]
                   if param[1].keys()|first in ssm_passwords_dict[param[0].key].passwords
                 else ''
             }
           }
         }, recursive=true) }}
  failed_when: ssm_passwords_dict[param[0].key].newpasswords[param[1].keys()|first] == None
  loop_control:
    loop_var: param
    label: "{{ param[0].key }}:{{ param[1].keys()|first }}"
  with_subelements:
    - "{{ ssm_passwords | dict2item }}"
    - value.users

- name: Check parameters which require updating
  set_fact:
    ssm_passwords_dict: |
      {{ ssm_passwords_dict | combine({
           param.key: {
               'passwords' : ssm_passwords_dict[param.key].passwords | combine(ssm_passwords_dict[param.key].newpasswords),
               'upload': ssm_passwords_dict[param.key].newpasswords != ssm_passwords_dict[param.key].oldpasswords
           }
         }, recursive=true) }}
  loop_control:
    loop_var: param
    label: "{{ param.key }}"
  loop: "{{ ssm_passwords | dict2item }}"

- name: Create fact with updated parameters
  set_fact:
    ssm_passwords_to_update: "{{ ssm_passwords_dict | dict2item | selectattr('value.upload', 'equalto', true) }}"

# - debug:
#   var: ssm_passwords_to_update

# Not using community.aws.ssm_parameter as this requires some additional
# parameters such as ssm:DescribeParameters at root level
- name: Upload updated parameters
  ansible.builtin.shell: |
    PATH=$PATH:/usr/local/bin
    aws ssm put-parameter --name '{{ param.value.parameter }}' --type 'SecureString' --data-type 'text' --value '{{ param.value.passwords|to_json }}' --overwrite
  loop_control:
    loop_var: param
    label: "{{ param.key }}"
  loop: "{{ ssm_passwords_to_update }}"

- name: Update upload fact
  set_fact:
    ssm_passwords_dict: |
      {{ ssm_passwords_dict | combine({
           param.key: {
               'upload': False
           }
         }, recursive=true) }}
  loop_control:
    loop_var: param
    label: "{{ param.key }}"
  loop: "{{ ssm_passwords | dict2item }}"
