---
- name: is collectd installed
  ansible.builtin.command: yum list | grep collectd
  register: collectd_installed
  check_mode: no
  changed_when: false
  ignore_errors: true

- name: Ensure the EPEL repository is available on Rhel 7
  block:
    - name: Ensure the EPEL repository is available
      ansible.builtin.package:
        name: epel-release
        state: installed
      register: epel_release_installed
      ignore_errors: true

    - name: Add epel-release to repolist
      ansible.builtin.shell: |
        yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
      when: epel_release_installed is failed
      ignore_errors: true

    - name: install collectd from epel-release
      ansible.builtin.package:
        name: collectd
        state: installed

  when: (ansible_distribution_major_version == '7') and (collectd_installed != 0)

- name: Ensure the EPEL repository is available on Rhel 6
  block:
    - name: Ensure the EPEL repository is available on Rhel 6
      ansible.builtin.package:
        name: epel-release
        state: installed
      register: epel_release_installed
      ignore_errors: true

    - name: Add epel-release to repolist on Rhel 6
      ansible.builtin.shell: |
        wget https://dl.fedoraproject.org/pub/archive/epel/6/x86_64/epel-release-6-8.noarch.rpm
        yum install -y epel-release-6-8.noarch.rpm
      when: epel_release_installed is failed
      ignore_errors: true # role to be re-run without failing

    # using shell as yum module doesn't run on Rhel6 due to old python version
    - name: Install collectd agent
      ansible.builtin.shell: |
        yum install -y collectd

  when: (ansible_distribution_major_version == '6') and (collectd_installed != 0)

- name: Ensure the EPEL repository is available on Rhel 8.7
  block:
    - name: Ensure the EPEL repository is available on Rhel 8.7
      ansible.builtin.package:
        name: epel-release
        state: installed
      register: epel_release_installed
      ignore_errors: true

    - name: Add epel-release to repolist on Rhel 8.7
      ansible.builtin.shell: |
        wget https://dl.fedoraproject.org/pub/archive/epel/8.5/Everything/x86_64/Packages/e/epel-release-8-15.el8.noarch.rpm
        yum install -y epel-release-8-15.el8.noarch.rpm
      when: epel_release_installed is failed

    # using shell as yum module doesn't run on Rhel6 due to old python version
    - name: Install collectd agent
      ansible.builtin.shell: |
        yum install -y collectd

  when: (ansible_distribution_version == '8.7') and (collectd_installed != 0)
