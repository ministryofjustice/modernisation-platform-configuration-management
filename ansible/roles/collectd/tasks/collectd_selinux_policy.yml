---
- name: create folder for selinux policy file
  ansible.builtin.file:
    path: /opt/selinux
    state: directory
    mode: 0755

- name: copy selinux policy
  copy:
    src: "collectd_selinux_policy_rhel_{{ ansible_distribution_major_version }}.te"
    dest: /opt/selinux/collectd_selinux_policy.te
    mode: 0644
  register: copy_selinux_policy

- name: compile and load selinux policy
  ansible.builtin.shell: |
    set -eo pipefail
    main() {
      checkmodule -M -m -o /opt/selinux/collectd_selinux_policy.mod /opt/selinux/collectd_selinux_policy.te
      semodule_package -o /opt/selinux/collectd_selinux_policy.pp -m /opt/selinux/collectd_selinux_policy.mod
      semodule -i /opt/selinux/collectd_selinux_policy.pp
    }
    main 2>&1 | logger -p local3.info -t ansible-collectd
  when: copy_selinux_policy.changed
