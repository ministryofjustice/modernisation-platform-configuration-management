---
- name: check whether selinux policy is enabled or not
  command: getenforce
  register: selinux_status
  changed_when: false
  ignore_errors: true

- block: # when selinux mode is 'Enforcing'
    - name: make sure collectd has run for 3 minutes to capture all the errors
      pause:
        minutes: 5 # may need to be extended if this doesn't allow enough time for all issues to be captured
      when: ansible_distribution_major_version != '7' # run this on everything apart from RHEL 7 for now

    # also checks if there's a policy to enforce, if not then no subsequent tasks will run
    - name: capture selinux AVC rules from audit log around collectd
      ansible.builtin.shell: |
        result=$(grep 'AVC.*collectd\|collectd.*AVC' /var/log/audit/audit.log)
        if [[ $result ]]; then
          echo "$result" | audit2allow -m collectd_selinux_policy > /opt/collectd/collectd_selinux_policy.te
        fi
      become: true
      changed_when: false # don't want to fail if no selinux AVC rules are found for collectd
      when: ansible_distribution_major_version != '7' # run this on everything apart from RHEL 7 for now

    - name: provide pre-built selinux policy file for Rhel 7
      copy:
        src: collectd_selinux_policy_rhel_7.te
        dest: /opt/collectd/collectd_selinux_policy.te
        mode: 0644
      become: true
      when: ansible_distribution_major_version == '7' # run this on RHEL 7 only

    - name: check if selinux policy file exists
      become: true
      ansible.builtin.stat:
        path: /opt/collectd/collectd_selinux_policy.te
      register: te_file

    - name: convert and compile .te policy to .pp policy
      ansible.builtin.shell: |
        checkmodule -M -m -o /opt/collectd/collectd_selinux_policy.mod /opt/collectd/collectd_selinux_policy.te
        semodule_package -o /opt/collectd/collectd_selinux_policy.pp -m /opt/collectd/collectd_selinux_policy.mod
      become: true
      when: te_file.stat.exists

    - name: Check if .pp file exists (RHEL 7+)
      stat:
        path: /opt/collectd/collectd_selinux_policy.pp
      register: pp_file

    - name: Load .pp policy (RHEL 6 or 7+)
      ansible.builtin.shell: |
        semodule -i /opt/collectd/collectd_selinux_policy.pp
      become: true
      when: pp_file.stat.exists
      notify: restart collectd

  when: selinux_status.stdout == 'Enforcing'
