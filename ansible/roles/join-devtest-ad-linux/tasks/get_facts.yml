---
- name: Get secretsmanager passwords
  block:
    - name: secretsmanager passwords
      import_role:
        name: secretsmanager-passwords
      vars:
        secretsmanager_passwords: "{{ service_account_secretsmanager_passwords }}"

    - name: secretsmanager passwords
      set_fact:
        join_domain_linux_service_account_username: "{{ secretsmanager_passwords_dict['service_account'].passwords['username'] }}"
        join_domain_linux_service_account_password: "{{ secretsmanager_passwords_dict['service_account'].passwords['password'] }}"

  when: not use_ssm_params

- name: Get SSM params
  block:
    - name: Get SSM parameters
      import_role:
        name: ssm-passwords
      vars:
        ssm_passwords: "{{ service_account_ssm_passwords }}"

    - name: Get SSM parameters
      set_fact:
        join_domain_linux_service_account_username: "{{ ssm_passwords_dict['service_account'].passwords['username'] }}"
        join_domain_linux_service_account_password: "{{ ssm_passwords_dict['service_account'].passwords['password'] }}"
      when: ssm_passwords_dict is defined

  when: use_ssm_params

- name: Check secrets
  set_fact:
    all_variables_set: true
  when:
    - join_domain_linux_service_account_username|length > 0
    - join_domain_linux_service_account_password|length > 0

- name: Fail if missing secrets
  fail:
    msg: Ensure all required parameters are set
  when: not all_variables_set|default(false)
