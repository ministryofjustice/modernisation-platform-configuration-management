---
- name: Check server has DB components
  ansible.builtin.stat:
    path: /etc/oratab
  register: db_server_file

- name: If database server , get DB from running process
  ansible.builtin.shell: ps -ef | grep pmon | grep -v ASM|  grep -v grep | head -1 | awk -F_ '{ print $3 }'
  register: db_instance_name
  when: db_server_file.stat.exists

- name: Set db name from ec2 oracle-db-name tag
  set_fact:
    db_sid: "{{ db_instance_name.stdout }}"
  when: db_server_file.stat.exists

- name: Check all SSM parameters and tags are set
  set_fact:
    db_all_variables_set: true
  when:
    - db_sid |length > 0

- name: Fail if missing SSM parameters or tags
  fail:
    msg: Ensure all required SSM parameters and tags are set
  when: not db_all_variables_set |default(false)
