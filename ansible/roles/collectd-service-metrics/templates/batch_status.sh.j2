#!/bin/bash

# Templated in from ansible
HOSTNAME="${HOSTNAME:-localhost}"
INTERVAL="{{ collectd_script_interval }}"
ORACLE_BATCH_ERROR_FILE="{{ oracle_batch_error_file }}"
ORACLE_BATCH_STATUSES="{{ oracle_batch_statuses }}"

batch_status() {

    local LINE="$1"
    local ORACLE_BATCH_ERROR_FILE="$2"
    
    # Check if the file contains any of the batch statuses we're looking for
    if [[ "$(cat $ORACLE_BATCH_ERROR_FILE | grep $LINE)" ]]
    then
        val="$(cat $ORACLE_BATCH_ERROR_FILE | grep "$LINE" | cut -f2 -d' ')"
        return "$val"
    else
        # if the line is not there then return a different value to be posted to a different metric
        return 2
    fi
}

while sleep "$INTERVAL"; do
    if [[ -s "${ORACLE_BATCH_ERROR_FILE}" ]]
    then
        echo "PUTVAL $HOSTNAME/exec-oracle_batch_monitoring_file_missing/bool interval=$INTERVAL N:0"
        for text in $ORACLE_BATCH_STATUSES; do
            batch_status "$text" "$ORACLE_BATCH_ERROR_FILE"
            status=$?
            if [[ $status == 0 ]] || [[ $status == 1 ]]
            then
                echo "PUTVAL $HOSTNAME/exec-$text/bool interval=$INTERVAL N:$status"
            else
                echo "PUTVAL $HOSTNAME/exec-${text}_value_missing/bool interval=$INTERVAL N:1"
            fi
        done
    else
        echo "PUTVAL $HOSTNAME/exec-oracle_batch_monitoring_file_missing/bool interval=$INTERVAL N:1"
    fi
done
