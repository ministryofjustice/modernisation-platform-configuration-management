---
- name: get the monitored_services
  set_fact:
    monitored_services: '{{ collectd_monitored_services | default([]) | join(" ") }}'
  when: collectd_monitored_services is defined

- name: debug
  ansible.builtin.debug:
    msg: "{{ monitored_services }}"

- name: create folder for exec script to collect metrics
  ansible.builtin.file:
    path: "/opt/collectd"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: copy plugin files
  ansible.builtin.copy:
    src: "{{ item }}.conf"
    dest: "/etc/collectd.d/{{ item }}.conf"
    owner: root
    mode: 0644
  loop:
    - monitored_services
  loop_control:
    label: item

- name: template config files
  ansible.builtin.template:
    src: "{{ item }}.sh.j2"
    dest: "/opt/collectd/{{ item }}.sh"
    owner: root
    mode: 0755
  loop:
    - monitored_services
  loop_control:
    label: item

- block:
  - name: templates batch_status and db_connected
    ansible.builtin.template:
      src: "{{ item }}.sh.j2"
      dest: "/opt/collectd/{{ item }}.sh"
      owner: root
      mode: 0755
    loop:
      - oracle_batch_status
      - oracle_db_connected
    loop_control:
      label: item

  - name: copy oracle monitoring unit files
    ansible.builtin.copy:
      src: "{{ item }}.service"
      dest: "/etc/systemd/system/{{ item }}.service"
      owner: root
      mode: 0644
    loop:
      - oracle-batch-status
      - oracle-db-connected
    loop_control:
      label: item
  when: ec2.tags['oracle-sids'] is defined
