#!/bin/bash
# This script configures/builds nodemanager/weblogic-admin/weblogic-managed-servers (Autologoff, Tagsar, Hotpage)

set -e

USAGE() { echo "Usage: weblogic-setup.sh [-h <DATABASE_HOSTNAME>] [-s <DATABASE_NAME (SID)>] [-p <DATABASE_PORT>]" 1>&2; exit 1; }

while getopts ":h:s:p:n:" OPT; do
        case $OPT in
                h) DB_HOSTNAME=${OPTARG};;
                s) DB_NAME=${OPTARG};;
                p) DB_PORT=${OPTARG};;
                n) EC2_NAME=${OPTARG};;
                :) echo "\n-${OPTARG} requires a value, check usage"
                   echo USAGE}
                   exit 1;;
                \?) echo USAGE
                   exit 1;;
        esac
done

oracle_commands() {

    # Retrieve configuration variables
    echo "# retrieving SSM parameters from {{ ssm_parameters_path }}"
    ADMIN_USERNAME=$(aws ssm get-parameter --name "{{ ssm_parameters_path }}/WEBLOGIC_USERNAME" --with-decryption --query Parameter.Value | tr -d '"')
    ADMIN_PASSWORD=$(aws ssm get-parameter --name "{{ ssm_parameters_path }}/WEBLOGIC_PASSWORD" --with-decryption --query Parameter.Value | tr -d '"')
    DB_USERNAME=$(aws ssm get-parameter --name "{{ ssm_parameters_path }}/DB_USERNAME" --with-decryption --query Parameter.Value | tr -d '"')
    DB_PASSWORD=$(aws ssm get-parameter --name "{{ ssm_parameters_path }}/DB_PASSWORD" --with-decryption --query Parameter.Value | tr -d '"')

    if [[ -z $ADMIN_USERNAME || -z $ADMIN_PASSWORD || -z $DB_USERNAME || -z $DB_PASSWORD ]]; then
      echo "ERROR: failed to get SSM parameters."
      exit 1
    fi

    echo "# updating configuration"
    # Insert managed server configuration variables for (DB_HOSTNAME is provided as an env var by Terraform)
    sed -i 's/${ADMIN_USERNAME}/'${ADMIN_USERNAME}'/g' /u01/software/forms/configure_only.rsp /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties
    sed -i 's/${ADMIN_PASSWORD}/'${ADMIN_PASSWORD}'/g' /u01/software/forms/configure_only.rsp /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties
    sed -i 's/${ADMIN_CONFIRM_PASSWORD}/'${ADMIN_PASSWORD}'/g' /u01/software/forms/configure_only.rsp
    sed -i 's/${DOMAIN_HOSTNAME}/'${HOSTNAME}'/g' /u01/software/forms/configure_only.rsp /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties /u01/software/weblogic/service/weblogic.properties
    sed -i 's/${DB_NAME}/'${DB_NAME}'/g' /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties
    sed -i 's/${DB_HOSTNAME}/'${DB_HOSTNAME}'/g' /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties
    sed -i 's/${DB_PORT}/'${DB_PORT}'/g' /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties
    sed -i 's/${DB_USERNAME}/'${DB_USERNAME}'/g' /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties
    sed -i 's/${DB_PASSWORD}/'${DB_PASSWORD}'/g' /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties

    echo "# running /u01/app/oracle/Middleware/forms_home/bin/config.sh"
    yes | bash /u01/app/oracle/Middleware/forms_home/bin/config.sh -silent -response /u01/software/forms/configure_only.rsp -invPtrLoc /var/opt/oracle/oraInst.loc

    # Wait for previous command to finish
    echo "# waiting for command to finish"
    tail --pid=$(pgrep -u oracle | tail -1) -f /dev/null

    # Weblogic admin console secrets (Values get encrypted automatically)
    echo "# updating boot.properties"
    echo "username=${ADMIN_USERNAME}
    password=${ADMIN_PASSWORD}" > /u01/app/oracle/Middleware/user_projects/domains/NomisDomain/servers/AdminServer/security/boot.properties

    # Copy configuration files
    echo "# moving config files to correct locations"
    copy_managed_server_files

    # Apply patches
    echo "# running setDomainEnv.sh"
    . /u01/app/oracle/Middleware/user_projects/domains/NomisDomain/bin/setDomainEnv.sh
    cd /u01/software/forms_patch/9473270
    echo "# running opatch apply"
    opatch apply -silent
    echo "# running opatch lsinventory"
    opatch lsinventory
    echo "# running opmctl stopall"
    opmnctl stopall

    cd $ORACLE_HOME/forms/lib
    echo "# make -f ins_forms.mk frmcmp_install"
    /usr/bin/make -f ins_forms.mk frmcmp_install
    echo "# make -f ins_forms.mk frmbld_install"
    /usr/bin/make -f ins_forms.mk frmbld_install
    echo "# make -f ins_forms.mk frmcmpb_install"
    /usr/bin/make -f ins_forms.mk frmcmpb_install
    echo "# make -f ins_forms.mk frmweb_install"
    /usr/bin/make -f ins_forms.mk frmweb_install
    echo "# make -f ins_reports.mk install"
    cd $ORACLE_HOME/reports/lib && /usr/bin/make -f ins_reports.mk install

    # Start node manager and weblogic as daemon processes
    echo "# set WLS env"
    . $WL_HOME/server/bin/setWLSEnv.sh
    echo "# startNodeManager"
    nohup /u01/app/oracle/Middleware/wlserver_10.3/server/bin/startNodeManager.sh >>nohup.out 2>&1 &
    echo "# startWebLogic"
    nohup /u01/app/oracle/Middleware/user_projects/domains/NomisDomain/bin/startWebLogic.sh >>nohup.out 2>&1 &
    echo "# opmnctl startall"
    opmnctl startall

    # Check db connection & Compile forms
    echo "# Compile forms"
    /u01/tag/utils/scripts/doallforms.sh -s /u01/tag/FormsSources -o /u01/tag/FormsObjects -e "${DB_NAME}" -p ${DB_PASSWORD}

    # Create Managed Servers
    # (i) Autologoff
    echo "# Create Managed Servers Autologoff"
    java weblogic.WLST /u01/software/weblogic/create_managed_app.py -p /u01/software/weblogic/autologoff.properties
    # (ii) Create TagSar
    echo "# Create Managed Servers TagSar"
    java weblogic.WLST /u01/software/weblogic/create_managed_app.py -p /u01/software/weblogic/tagsar.properties
    # (iii) Create HotPage
    echo "# Create Managed Servers HotPage"
    java weblogic.WLST /u01/software/weblogic/create_managed_app.py -p /u01/software/weblogic/hotpage.properties

    echo "# Cleanup"
    rm -f /u01/software/weblogic/tagsar.properties /u01/software/weblogic/hotpage.properties /u01/software/weblogic/autologoff.properties
}

copy_managed_server_files() {
    # Move the concfig files into the correct locations (Directory env vars are defined in bash profile)
    cp -p /u01/software/config/java/*.jar ${ORACLE_HOME}/forms/java
    cp /u01/software/config/jacob-1.14.3-x86.dll ${ORACLE_HOME}/forms/webutil/win32/
    cp /u01/software/config/PRSDK.dll ${ORACLE_HOME}/forms/webutil/win32/
    cp /u01/software/config/PRLIB.dll ${ORACLE_HOME}/forms/webutil/win32/

    cp /u01/software/config/fmrweb.res ${ORACLE_INSTANCE}/config/FormsComponent/forms/admin/resource/US
    cp /u01/software/config/fmrweb_utf8.res ${ORACLE_INSTANCE}/config/FormsComponent/forms/admin/resource/US
    cp /u01/software/config/webutil.cfg ${ORACLE_INSTANCE}/config/FormsComponent/forms/server
    cp /u01/software/config/httpd.conf ${ORACLE_INSTANCE}/config/OHS/ohs1/httpd.conf
    sed -i 's/DynamicServerList OFF/DynamicServerList ON\
            \DebugConfigInfo ON/g' ${ORACLE_INSTANCE}/config/OHS/ohs1/moduleconf/forms.conf
    sed -i 's/${DOMAIN_HOSTNAME}/$HOSTNAME/g' ${ORACLE_INSTANCE}/config/OHS/ohs1/httpd.conf
    cp /u01/software/config/formsweb.cfg ${DOMAIN_HOME}/config/fmwconfig/servers/WLS_FORMS/applications/formsapp_11.1.2/config
    cp /u01/software/config/tag.env ${DOMAIN_HOME}/config/fmwconfig/servers/WLS_FORMS/applications/formsapp_11.1.2/config

    cp /u01/software/config/setDomainEnv.sh ${DOMAIN_HOME}/bin
    cp /u01/tag/tagsar/applib/* ${DOMAIN_HOME}/lib/

    sed -i 's/${DB_NAME}/'${DB_NAME}'/g' /u01/software/config/tnsnames.ora
    sed -i 's/${DB_HOSTNAME}/'${DB_HOSTNAME}'/g' /u01/software/config/tnsnames.ora
    sed -i 's/${DB_PORT}/'${DB_PORT}'/g' /u01/software/config/tnsnames.ora
    cp /u01/software/config/tnsnames.ora ${ORACLE_INSTANCE}/config/
    cp /u01/software/config/tnsnames.ora ${ORACLE_HOME}/network/admin/

    mkdir -p /home/oracle/admin/scripts
    cp -p /u01/software/weblogic/service/* /home/oracle/admin/scripts/

    cp /u01/app/oracle/Middleware/forms_home/forms/webutil.pll /u01/tag/FormsSources/WEBUTIL.pll
    cp -p /u01/tag/FormsObjects/* /u01/tag/forms
}

main() {
    oracle_commands
}

main
