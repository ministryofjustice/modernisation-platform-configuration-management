---
- name: Get secretsmanager secrets
  import_role:
    name: secretsmanager-passwords
  vars:
    secretsmanager_passwords: "{{ sap_bip_secretsmanager_passwords }}"

- name: Set secretsmanager password facts
  set_fact:
    sap_bip_cms_cluster_name: "{{ secretsmanager_passwords_dict['config'].passwords['cms_cluster_name'] }}"
    sap_bip_cms_cluster_key: "{{ secretsmanager_passwords_dict['config'].passwords['cms_cluster_key'] }}"
    sap_bip_cms_primary_hostname: "{{ secretsmanager_passwords_dict['config'].passwords['cms_primary_hostname'] }}"
    sap_bip_product_key: "{{ secretsmanager_passwords_dict['config'].passwords['product_key'] }}"
    sap_bip_cms_admin_password: "{{ secretsmanager_passwords_dict['passwords'].passwords['cms_admin_password'] }}"
    sap_bip_cms_db_password: "{{ secretsmanager_passwords_dict['sysdb'].passwords[sap_bip_cms_db_user] }}"
    sap_bip_auditing_db_password: "{{ secretsmanager_passwords_dict['auditdb'].passwords[sap_bip_auditing_db_user] }}"

- name: Check all secrets are set
  set_fact:
    bip_all_variables_set: true
  when:
    - sap_bip_cms_cluster_name|length > 0
    - sap_bip_cms_cluster_key|length > 0
    - sap_bip_cms_primary_hostname|length > 0
    - sap_bip_product_key|length > 0
    - sap_bip_cms_admin_password|length > 0
    - sap_bip_cms_db_password|length > 0
    - sap_bip_auditing_db_password|length > 0

- name: Fail if missing secrets
  fail:
    msg: Ensure all required secrets are set
  when: not bip_all_variables_set|default(false)
