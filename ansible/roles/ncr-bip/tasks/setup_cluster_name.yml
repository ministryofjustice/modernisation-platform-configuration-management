---
- name: Check if ccm.config present
  ansible.builtin.stat:
    path: "{{ sap_bip_installation_directory }}/sap_bobj/ccm.config"
  register: cluster_name_ccm_config_check

- block:

    - name: Check cluster name
      ansible.builtin.expect:
        command: "su - bobj -c \". /home/bobj/.bash_profile && {{ sap_bip_installation_directory }}/sap_bobj/cmsdbsetup.sh\""
        responses:
          "Specify the name of the node.":
            - "{{ sap_bip_sia_name_cms }}"
          "Current cluster key":
            - "0"
          "Are you sure you want to quit":
            - "1"
      changed_when: false
      failed_when: false
      register: get_cmsdbsetup_output

    - name: Extract cluster name from cmsdbsetup.sh output part 1
      set_fact:
        sap_bip_current_cms_cluster_name_regex: "{{ get_cmsdbsetup_output.stdout | regex_search('Current cluster name: (\\S+)','\\1') }}"

    - name: Fail if no cluster name found
      ansible.builtin.fail:
        msg: "Could not extract cluster name from {{ get_cmsdbsetup_output.stdout }}"
      when: sap_bip_current_cms_cluster_name_regex|length != 1

    - name: Extract cluster name from cmsdbsetup.sh output part 2
      set_fact:
        sap_bip_current_cms_cluster_name: "{{ sap_bip_current_cms_cluster_name_regex[0] }}"

    - name: Debug cluster name
      ansible.builtin.debug:
        msg: "Current cluster name [{{ sap_bip_current_cms_cluster_name }}]; Desired cluster name [{{ sap_bip_cms_cluster_name }}]"

    - name: Update cluster name
      ansible.builtin.expect:
        command: "su - bobj -c \". /home/bobj/.bash_profile && {{ sap_bip_installation_directory }}/sap_bobj/cmsdbsetup.sh\""
        responses:
          "Specify the name of the node.":
            - "{{ sap_bip_sia_name_cms }}"
          "Current cluster key":
            - "3"
          "Specify the new cluster name.":
            - "{{ sap_bip_cms_cluster_name }}"
      when: sap_bip_current_cms_cluster_name != sap_bip_cms_cluster_name
      failed_when: false
      register: set_cmsdbsetup_output

    - name: Fail if cluster name change failed
      ansible.builtin.fail:
        msg: "Could not set cluster name {{ set_cmsdbsetup_output.stdout }}"
      when:
        - sap_bip_current_cms_cluster_name != sap_bip_cms_cluster_name
        - not "Cluster name change was successful." in set_cmsdbsetup_output.stdout

  # Â block
  when: cluster_name_ccm_config_check.stat.exists
