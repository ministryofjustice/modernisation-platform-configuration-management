---

- name: Create nomis xtag domain
  block:

    - name: Copy scripts and properties files 
      ansible.builtin.template:
        src: "10.3{{ item }}"
        dest: "{{ item }}"
        owner: oracle
        group: oinstall
      loop:
        - /u01/software/weblogic/WLS_XTAG_OUTBOUND_01.properties
        - /u01/software/weblogic/domain.properties
        - /u01/software/weblogic/AdminServer.properties

    - name: Start nodemanager 
      become_user: oracle
      ansible.builtin.shell: |
        set -eo pipefail
        . ~/.bash_profile
        . $WL_HOME/server/bin/setWLSEnv.sh
         nohup /u01/app/oracle/Middleware/wlserver_10.3/server/bin/startNodeManager.sh &

    - name: Create weblogic Nomis xtag domain 
      become_user: oracle
      ansible.builtin.shell: |
        set -eo pipefail
        . ~/.bash_profile
        . $WL_HOME/server/bin/setWLSEnv.sh
        java weblogic.WLST ~/admin/scripts/create_managed_app.py -p /u01/software/weblogic/domain.properties

    - name: Create security directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: oracle
        group: oinstall
        mode: "0755"
      loop:
        - /u01/app/oracle/Middleware/user_projects/domains/NomisDomain/servers/AdminServer/security

    # the boot.properties file is automatically updated by the weblogic server
    - name: Copy Admin server boot properties file 
      ansible.builtin.template:
        src: "10.3/u01/app/oracle/Middleware/user_projects/domains/NomisDomain/servers/AdminServer/security/boot.properties"
        dest: "{{ item }}"
        owner: oracle
        group: oinstall
        force: false
      loop:
        - /u01/app/oracle/Middleware/user_projects/domains/NomisDomain/servers/AdminServer/security/boot.properties

    # # - name: Start admin server 
    #   ansible.builtin.service:
    #     name: weblogic-server
    #     enabled: yes

    - name: Start Admin server 
      become_user: oracle
      ansible.builtin.shell: |
        set -eo pipefail
        . ~/.bash_profile
        . $WL_HOME/server/bin/setWLSEnv.sh
         nohup /u01/app/oracle/Middleware/user_projects/domains/NomisDomain/bin/startWebLogic.sh &