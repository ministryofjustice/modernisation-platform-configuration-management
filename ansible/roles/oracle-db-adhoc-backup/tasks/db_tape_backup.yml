---
- name: Backup database to tape
  block:
    - name: create rman backup script
      template:
        src: rman_tape_backup.cmd.j2
        dest: "{{ stage }}/rman_backup.cmd"
        owner: "{{ user_name }}"
        group: "{{ group_name }}"
        mode: "0700"

    - name: Copy controlfile backup script for standby
      template:
        src: rman_contrfolfile_backup_s3.cmd.j2
        dest: "{{ stage }}/rman_contrfolfile_backup_s3.cmd"
        owner: "{{ user_name }}"
        group: "{{ group_name }}"
        mode: "0700"
      when: BACKUP_FOR == "HA"

    - name: Run rman backup script
      become_user: oracle
      ansible.builtin.shell: |
        source oraenv <<< {{ db_name }}
        rman target / cmdfile="{{ stage }}/rman_backup.cmd" log="{{ stage }}/{{ LABEL }}_db_backup.log"

    - name: Take standby controlfile backup for HA creation  to S3 bucket
      ansible.builtin.shell: |
        source oraenv <<< {{ db_name }}
        rman target / cmdfile="{{ stage }}/rman_contrfolfile_backup_s3.cmd" log="{{ stage }}/{{ LABEL }}_db_backup.log"
      when: BACKUP_FOR == "HA"

    - name: Copy password file to S3 bucket
      ansible.builtin.shell: |
        source oraenv <<< {{ db_name }}
        aws s3 cp $ORACLE_HOME/dbs/orapw{{ db_name }} s3://{{ ansible_aws_ssm_bucket_name }}/

  become: true
  become_user: "{{ user_name }}"
  environment: "{{ db_env }}"
