---
- name: Fail if account ids lookup table not defined
  fail:
    msg: "Account_ids lookup not found, please check get-modernisation-platform-facts role ran successfully"
  when: account_ids is not defined

- name: Setup facts
  set_fact:
    secretsmanager_passwords_dict: "{{ secretsmanager_passwords_dict|default({}) }}"
    secretsmanager_passwords_self: "{{ secretsmanager_passwords | rejectattr('account_name', 'defined') }}"
    secretsmanager_passwords_other: "{{ secretsmanager_passwords | selectattr('account_name', 'defined') }}"

# If this fails, ensure secret has been created via terraform first
- name: Form Secret Ids - Self
  set_fact:
    secretsmanager_passwords_dict: |
      {{ secretsmanager_passwords_dict | combine({
           item.key: {
               'id': item.secret
           }
         }, recursive=true) }}
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ secretsmanager_passwords_self }}"

# If this fails, ensure secret has been created via terraform first and has been
# shared into this account
- name: Form Secret Ids - Other accounts
  set_fact:
    secretsmanager_passwords_dict: |
      {{ secretsmanager_passwords_dict | combine({
           item.key: {
               'id': 'arn:aws:secretsmanager:eu-west-2:' + account_ids[item.account_name] + ':secret:' + item.secret
           }
         }, recursive=true) }}
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ secretsmanager_passwords_other }}"

- name: Get SecretManager Secrets
  set_fact:
    secretsmanager_passwords_dict: |
      {{ secretsmanager_passwords_dict | combine({
           item.key: {
             'value': lookup('amazon.aws.aws_secret', secretsmanager_passwords_dict[item.key].id, region='eu-west-2')
           }
         }, recursive=true) }}
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ secretsmanager_passwords }}"

- name: Prepare any placeholder secrets
  set_fact:
    secretsmanager_passwords_dict: |
      {{ secretsmanager_passwords_dict | combine({
           item.key: {
             'passwords': {} if 'placeholder' in secretsmanager_passwords_dict[item.key].value else secretsmanager_passwords_dict[item.key].value|from_json
           }
         }, recursive=true) }}
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ secretsmanager_passwords }}"

# The if statement:
# - use the password defined in the secretsmanager_passwords variable if there is one
# - else use existing password defined in the secretsmanager_secret and force_rotate not set
# - else generate random password
- name: Generate any missing passwords
  set_fact:
    secretsmanager_passwords_dict: |
      {{ secretsmanager_passwords_dict | combine({
           item[0].key: {
             'passwords': {
               item[1].keys()|first:
                 item[1].values()|first 
                   if item[1].values()|first != None
                 else secretsmanager_passwords_dict[item[0].key].passwords[item[1].keys()|first]
                   if item[1].keys()|first in secretsmanager_passwords_dict[item[0].key].passwords 
                   and [item[0].key, item[1].keys()|first]|join(':') not in secretmanager_passwords_force_rotate
                 else lookup('ansible.builtin.password', '/dev/null chars=ascii_letters length=1')
                 + lookup('ansible.builtin.password', '/dev/null chars=ascii_letters,digits length=15')
             }
           }
         }, recursive=true) }}
  loop_control:
    label: "{{ item[0].key }}:{{ item[1].keys()|first }}"
  with_subelements:
    - "{{ secretsmanager_passwords }}"
    - users

- name: Check secrets which require updating
  set_fact:
    secretsmanager_passwords_dict: |
      {{ secretsmanager_passwords_dict | combine({
           item.key: {
               'upload': secretsmanager_passwords_dict[item.key].passwords|to_json != secretsmanager_passwords_dict[item.key].value
           }
         }, recursive=true) }}
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ secretsmanager_passwords }}"

# NOTE: if this fails, it might be because a password is marked as requiring
# update in a different account to where the secret is stored.  Update
# it in the account where the secret is stored instead
- name: Retrieve resource policy for any secrets requiring update
  ansible.builtin.shell: |
    if [[ {{ secretsmanager_passwords_dict[item.key].upload }} == True ]]; then
      PATH=$PATH:/usr/local/bin
      aws secretsmanager get-resource-policy --secret-id "{{ secretsmanager_passwords_dict[item.key].id }}" --query ResourcePolicy --output text
    fi
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ secretsmanager_passwords }}"
  check_mode: false
  changed_when: false
  register: secret_resource_policy

- name: Add resource policy to fact
  set_fact:
    secretsmanager_passwords_dict: |
      {{ secretsmanager_passwords_dict | combine({
           item.item.key: {
             'policy': item.stdout
           }
         }, recursive=true) }}
  loop: "{{ secret_resource_policy.results }}"

- name: Check secrets which require updating
  set_fact:
    secretsmanager_passwords_to_update: "{{ secretsmanager_passwords_dict | dict2items | selectattr('value.upload', 'equalto', true) }}"

- name: Upload updated secrets
  community.aws.secretsmanager_secret:
    region: "eu-west-2"
    name: "{{ item.value.id }}"
    secret: "{{ item.value.passwords|to_json }}"
    resource_policy: "{{ item.value.policy }}"
  loop_control:
    label: "{{ item.key }}"
  loop: "{{ secretsmanager_passwords_to_update }}"
