---
name: delius-data-refresh
permissions:
  id-token: write  # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout
on:
  workflow_dispatch:
    inputs:
      terraform_version:
        type: string
        required: false
        description: "The terraform version to use, default is temporarily set to 1.3.9 due to bugs in 1.4.0"
        default: "1.3.9"
  push:
    branches:
      - NIT-671-iaps-use-terraform-for-data-refresh
jobs:
  take-snapshot:
    outputs:
      SNAPSHOT_IDENTIFIER: ${{ steps.create-snapshot.outputs.SNAPSHOT_IDENTIFIER }}
    runs-on: ubuntu-latest
    steps:
      - name: install aws-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          sudo pip3 install awscli

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e1e17a757e536f70e52b5a12b2e8d1d1c60e04ef  # v2.0.0
        with:
          role-to-assume: "arn:aws:iam::${{ secrets.IAPS_PRODUCTION_ACCOUNT_ID }}:role/ci-data-refresher"
          role-session-name: githubactionsrolesession
          aws-region: "eu-west-2"

      - name: Create Snapshot
        id: create-snapshot
        run: |
          echo "pretend to create snapshot"
          snapshot_identifier=$(aws rds describe-db-snapshots \
            --snapshot-type "manual" \
            --db-instance-identifier "delius-iaps-production-database" \
            --query "reverse(sort_by(DBSnapshots, &SnapshotCreateTime))[0].DBSnapshotIdentifier" \
            --output text)
          if [ -z "$snapshot_identifier" ]; then
            echo "No snapshot found"
            exit 1
          fi
          echo SNAPSHOT_IDENTIFIER=${snapshot_identifier} >> $GITHUB_ENV
          echo SNAPSHOT_IDENTIFIER=${snapshot_identifier} >> $GITHUB_OUTPUT

      - name: Copy snapshot
        run: |
          echo "pretend to copy snapshot"

      - name: Wait for RDS Snapshot to be ready
        run: |
          aws rds wait db-snapshot-completed \
            --db-snapshot-identifier "${{ env.SNAPSHOT_IDENTIFIER }}"

      - name: Share RDS snapshot with Pre-Prod
        run: |
          aws rds modify-db-snapshot-attribute \
              --db-snapshot-identifier "${{ env.SNAPSHOT_IDENTIFIER }}" \
              --attribute-name restore \
              --values-to-add "${{ secrets.IAPS_PREPRODUCTION_ACCOUNT_ID }}"

  restore-preprod-db-from-snapshot:
    runs-on: ubuntu-latest
    needs: take-snapshot
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          repository: ministryofjustice/modernisation-platform-environments

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e1e17a757e536f70e52b5a12b2e8d1d1c60e04ef  # v2.0.0
        with:
          aws-access-key-id: ${{ secrets.IAPS_PREPROD_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.IAPS_PREPROD_SECRET_KEY }}
          aws-region: "eu-west-2"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1  # v2.0.3
        with:
          terraform_version: "${{ inputs.terraform_version }}"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: "terraform/environments/delius-iaps"
        run: |
          terraform init

      - name: Terraform Workspace Select
        working-directory: "terraform/environments/delius-iaps"
        run: |
          terraform workspace select delius-iaps-preproduction

      - name: Terraform apply
        working-directory: "terraform/environments/delius-iaps"
        run: |
          terraform apply -auto-approve -target="aws_db_instance.iaps" -var="rds_refresh_snapshot_id[0]=delius-iaps-production-database-snapshot-${DATESTAMP}"
